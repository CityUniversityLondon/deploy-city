var libraryAdmin=function(r){"use strict";var s,e,l=[],o=[],a=r(".modal"),d=r(".modal--delete"),n=r(".modal__box"),t=r(".modal__box--delete"),i=r(".modal__close"),_=r(".modal__close--delete"),c=r(".admin-calendar"),u=c.attr("data-library-id"),A=c.attr("data-calendar-date")||c.attr("data-today-date"),p=A.split("-")[0],v=A.split("-")[1],y={"Every weekday":"DWD","Every weekend day":"DWE","Every day":"DED","Every week":"WEW"},f=r("#event-template"),m=r(".calendarNavLink"),h=new Squiz_Matrix_API({key:"13123496783452586456"}),b=function(){var e=document.location;-1===e.pathname.search(/\_nocache/)?document.location=e.origin+e.pathname+"/_nocache"+e.search:document.location.reload(!0)},x=function(){"closed"===r("#modal__box__special").val()||"open24hours"===r("#modal__box__special").val()?r("#modal__box__times select").prop("disabled",!0):r("#modal__box__times select").prop("disabled",!1)},E=function(e,t){void 0===e?M(t,!1,null):"new modification"===e?M(t,!0,s):w(e),a.addClass("active"),r("[data-id='"+s+"']").removeClass("hover"),r("[data-id='"+s+"']").attr("aria-selected",!0)},D=function(){a.removeClass("active"),r("[data-id='"+s+"']").removeAttr("aria-selected")},k=function(e){r(".modal__box__delete-confirm").prop("disabled",!0);var t,a=new XMLHttpRequest,n="//www.city.ac.uk/api/library-opening-times/delete-event-children?root="+e;a.open("GET",n,!0),a.onreadystatechange=function(){4===this.readyState&&(200<=this.status&&this.status<400?(t=JSON.parse(this.responseText),0<Object.keys(t.children).length&&S(t),setTimeout(function(){r(".modal__box__delete-confirm").prop("disabled",!1)},500),o.push(e)):{error:!0})},a.send(),a=null,d.addClass("active")},g=function(){d.removeClass("active")},T=function(){var e,t,a;e=r("#modal__box__start-day").val(),t=r("#modal__box__end-day").val(),a=r("#modal__box__start-day option").length,parseInt(t,10)<parseInt(e,10)&&r("#modal__box__end-day option").filter(function(){return r(this).text()==e}).prop("selected",!0),r("#modal__box__end-day option").prop("disabled",!1);for(var n=1;n<=a;n++)n<parseInt(e,10)&&r("#modal__box__end-day option:nth-child("+n+")").prop("disabled",!0)},C=function(){var e,t,a;e=r("#modal__box__start-hour").val(),t=r("#modal__box__end-hour").val(),a=r("#modal__box__start-hour option").length,parseInt(t,10)<parseInt(e,10)&&0!=parseInt(t,10)&&r("#modal__box__end-hour option").filter(function(){return r(this).text()==e}).prop("selected",!0),r("#modal__box__end-hour option").prop("disabled",!1);for(var n=2;n<=a;n++)n<=parseInt(e,10)&&r("#modal__box__end-hour option:nth-child("+n+")").prop("disabled",!0)},w=function(e){I(e)},M=function(e,t,a){var n={startDay:e,endDay:"",startHour:"",startMonth:v,startYear:p,startMinute:"",duration:"",endDay:"",endHour:"",endMinute:"",frequency:"",frequencyIcal:"",label:"",modification:t,specialTime:"",weekdays:!1,weekends:!1,legendText:"You are creating a new Event.",eventType:"new",deleteButton:!1,eventTypeToCreate:!0===t?"calendar_event_modification":"calendar_event_recurring",parentModificationId:!0===t?a:""},o=H(f.html(),n,n.parentModificationId);O(o)},I=function(e){var t;t="",t+=H(f.html(),libraryData[e],e),O(t)},H=function(e,t,a){for(var n="",o="",d="",i="",r="",s="",l="",_="",c="",u="",p="",v="",y="",f=t.modification,m=["01","02","03","04","05","06","07","08","09","10","11","12","13","14","15","16","17","18","19","20","21","22","23","24","25","26","27","28","29","30","31"],h=["00","01","02","03","04","05","06","07","08","09","10","11","12","13","14","15","16","17","18","19","20","21","22","23"],b=["00","01","02","03","04","05","06","07","08","09","10","11","12","13","14","15","16","17","18","19","20","21","22","23","24","25","26","27","28","29","30","31","32","33","34","35","36","37","38","39","40","41","42","43","44","45","46","47","48","49","50","51","52","53","54","55","56","57","58","59"],x={"":"None",closed:"Closed",open24hours:"Open 24 Hours"},E={"":"None","bank-holiday":"Bank Holiday","christmas-holiday":"Christmas Holiday","easter-holiday":"Easter Holiday","exam-period":"Exam Period"},D={"Every day":"Every Day","Every week":"Once a Week","Every weekday":"Every Weekday","Every weekend day":"Every Weekend"},k=q(t.startYear,t.startMonth),g=["January","February","March","April","May","June","July","August","September","October","November","December"][parseInt(A.split("-")[1])-1],T=A.split("-")[0],C=0;C<k;C++)m[C]===t.startDay?n+="<option selected>"+m[C]+"</option>":n+="<option>"+m[C]+"</option>",m[C]===t.endDay?i+="<option selected>"+m[C]+"</option>":i+="<option>"+m[C]+"</option>";for(C=0;C<h.length;C++)h[C]===t.startHour?o+="<option selected>"+h[C]+"</option>":o+="<option>"+h[C]+"</option>",h[C]===t.endHour?r+="<option selected>"+h[C]+"</option>":r+="<option>"+h[C]+"</option>";for(C=0;C<b.length;C++)b[C]===t.startMinute?d+="<option selected>"+b[C]+"</option>":d+="<option>"+b[C]+"</option>",b[C]===t.endMinute?s+="<option selected>"+b[C]+"</option>":s+="<option>"+b[C]+"</option>";for(var w in x)x.hasOwnProperty(w)&&(w===t.specialTime?l+='<option value="'+w+'" selected>'+x[w]+"</option>":l+='<option value="'+w+'">'+x[w]+"</option>");for(var w in E)E.hasOwnProperty(w)&&(w===t.label?_+='<option value="'+w+'" selected>'+E[w]+"</option>":_+='<option value="'+w+'">'+E[w]+"</option>");if(f)u="You are editing an exception.",p="exception",c+='<option value="never" selected>never</option>';else{for(var w in D)D.hasOwnProperty(w)&&(w===t.frequency?c+='<option value="'+w+'" selected>'+D[w]+"</option>":c+='<option value="'+w+'">'+D[w]+"</option>");u=t.legendText||"You are editing an existing event.",p=t.eventType||"existing",e=N(e,i,"@@END_DAY@@")}return t.deleteButton&&(v='<button class="modal__box__delete"><i class="fa  fa-times"></i>Delete Event</button>'),y=""===a?"":a,e=N(e,t.eventTypeToCreate,"@@ASSET_TYPE@@"),e=N(e,p,"@@EVENTTYPE@@"),e=N(e,u,"@@LEGEND@@"),e=N(e,n,"@@START_DAY@@"),e=N(e,g+" "+T,"@@MONTH_YEAR@@"),e=N(e,T,"@@YEAR@@"),e=N(e,g,"@@MONTH@@"),e=N(e,o,"@@START_HOUR@@"),e=N(e,d,"@@START_MINUTE@@"),e=N(e,r,"@@END_HOUR@@"),e=N(e,s,"@@END_MINUTE@@"),e=N(e,c,"@@RECURRENCE@@"),e=N(e,v,"@@DELETE_BUTTON@@"),e=N(e,y,"@@EVENT_ID@@"),e=N(e,l,"@@SPECIAL@@"),e=N(e,_,"@@LABEL@@")},N=function(e,t,a){var n=new RegExp(a,"g");return e.replace(n,t)},O=function(e){n.html(e),T(),document.getElementById("modal__box__start-day").addEventListener("change",function(){T()}),C(),document.getElementById("modal__box__start-hour").addEventListener("change",function(){C()}),x(),document.getElementById("modal__box__special").addEventListener("change",function(){x()})},q=function(e,t){for(var a=new Date(e,t-1,1),n=[];a.getMonth()===t-1;)n.push(a.getDate()),a.setDate(a.getDate()+1);return n.length},L=function(){var e,t,a={assetid:r(".modal__box__event-id").val(),startDay:r(".modal__box__start-day").val(),endDay:r(".modal__box__end-day").val(),startHours:r(".modal__box__start-hour").val(),startMinutes:r(".modal__box__start-minute").val(),endHours:r(".modal__box__end-hour").val(),endMinutes:r(".modal__box__end-minute").val(),specialOpen:r(".modal__box__special").val(),specialPeriod:r(".modal__box__label").val(),frequency:r(".modal__box__recurrence").val(),assetType:r(".modal__box__event-asset-type").val()};"undefined"===a.assetType?R(a,void 0):(e=r(".modal__box__year").val()+" "+r(".modal__box__month").val()+" "+a.startDay,a.endDay!==a.startDay&&(e+=" - "+a.endDay,"Every week"===a.frequency?e+=" (weekly)":"Every weekday"===a.frequency?e+=" (weekdays)":"Every weekend"===a.frequency&&(e+=" (weekends)")),t="frequency="+y[a.frequency],t+="&stop_date="+p+"-"+v+"-"+a.endDay,t+="&start_date="+p+"-"+v+"-"+a.startDay,h.createAsset({parent_id:"calendar_event_recurring"===a.assetType?parseInt(u):parseInt(a.assetid),type_code:a.assetType,asset_name:e,link_type:1,link_value:"",sort_order:1,is_dependant:0,is_exclusive:0,extra_attributes:1,attributes:t,dataCallback:function(e){R(a,e.id)}}))},R=function(e,t){var a=t||e.assetid;h.setMultipleAttributes({asset_id:a,field_info:{start_date:p+"-"+v+"-"+e.startDay,stop_date:p+"-"+v+"-"+e.endDay,frequency:y[e.frequency]},dataCallback:function(){h.setMetadataAllFields({asset_id:a,field_info:{469909:p+"-"+v+"-"+e.startDay+" "+e.startHours+":"+e.startMinutes+":00",469915:p+"-"+v+"-"+(null===e.endDay?e.startDay:e.endDay)+" "+e.endHours+":"+e.endMinutes+":00",469908:e.specialOpen,469913:e.specialPeriod,469914:null===e.endDay||e.startDay===e.endDay},dataCallback:function(e){h.setAssetStatus({asset_id:a,status:16,cascade:0,dataCallback:function(){b()}})}})}})},S=function(e){for(var t,a=r(".modal__box--delete__exceptions__list"),n=1;n<=Object.keys(e.children).length;n++)t=e.children[n],a.append('<li data-id="'+t.id+'">'+t.startDay+" "+t.times+"</li>"),o.push(t.id);r(".modal__box--delete__exceptions").css("display","block")},Y=function(e){h.setAssetStatus({asset_id:e,status:2,cascade:1,dataCallback:function(){h.trashAsset({asset_ids:[e],dataCallback:function(){b()}})}})};return{init:function(){!function(){var t,a,n,o,d,i;c.find(".eventDate").find(".dateLink").remove(),m.each(function(){r(this).attr("href",r(this).attr("href")+"&root="+u)}),(e=c.find(".eventDate")).each(function(){t=r(this),a=t.find("[data-id]"),s=a.attr("data-id"),o=a.attr("data-date"),d=a.attr("data-special"),i=a.attr("data-label"),r.inArray(s,l)<0&&l.push(s),t.attr({"data-id":s,"data-date":o,"data-special":d,"data-label":i}),n=l.length;for(var e=0;e<n;e++)r("[data-id='"+l[e]+"']").parents(".eventDate").addClass("event--"+(e+1));a.removeAttr("data-id data-date data-special data-label")}),r(".calendar").removeClass("calendar--loading")}(),e.hover(function(){s=r(this).attr("data-id"),r("[data-id='"+s+"']").addClass("hover")},function(){r("[data-id='"+s+"']").removeClass("hover")}),r(".unused").hover(function(){r(this).addClass("hover")},function(){r(this).removeClass("hover")}),c.find(".date").click(function(e){var t=r(this),a="";if(!r(e.target).hasClass("event__add-exception"))return t[0].hasAttribute("data-id")?(s=r(this).attr("data-id"),void E(s,void 0)):(a=t.find(".dateLink").html(),void E(void 0,parseInt(a)<10?"0"+a:a));E("new modification",t.attr("data-date").split(" ")[0])}),_.click(function(){g()}),i.click(function(){D()}),r(document).keyup(function(e){27===e.keyCode&&(d.hasClass("active")?g():a.hasClass("active")&&D())}),n.on("click",function(e){var t=r(e.target);e.preventDefault(),t.hasClass("modal__box__submit")&&(n.addClass("modal__box--loading"),n.off("click"),L()),t.hasClass("modal__box__delete")&&(n.off("click"),k(s))}),t.on("click",function(e){r(e.target).hasClass("modal__box__delete-confirm")&&(e.preventDefault(),Y(s))})}}}(jQuery);libraryAdmin.init();