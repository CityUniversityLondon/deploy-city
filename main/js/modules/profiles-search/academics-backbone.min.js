!function(e,t){function i(e){CITY.debug(e)}var a=$("<button />",{"class":"scroll-btn visible",html:'<span class="fa fa-arrow-up"></span><span class="visuallyhidden">scroll to top of page</a>',click:function(e){e.preventDefault(),$("html, body").animate({scrollTop:0},500)}}),l={collections:{academicsCollection:{}},views:{academicsListView:{},facetsView:{}},router:{}},s=e.Model.extend({}),n=Backbone.Paginator.clientPager.extend({model:s,initialize:function(){this.setDefaults()},paginator_core:{dataType:"json",url:"/fb/search.json"},paginator_ui:{perPage:20},server_api:{collection:"academics",landing:"true",sort:"metaR"},parse:function(e){var t=[];return e.response&&e.response.resultPacket?(_.each(e.response.resultPacket.results,function(e){var i={};_.each(e,function(e,t){if(_.isObject(e))_.each(e,function(e,t){i[t]=e});else if(_.isArray(e)){if(!e.length)return;i[t]=e}else i[t]=e}),t.push(i)}),t):t},searchFunnelback:function(e){var t,i=this.server_api,a=this,l=$(".academics").data("cul-fb-school");l&&(i.meta_E_sand=l),delete i.sort,t=decodeURIComponent($.param(_.extend(i,{query:e}))),this.fetch({success:function(){a.sortedAndFilteredModels=a.models.slice(),a.info()},data:t})}}),r=['<div itemscope itemtype="http://schema.org/Person">','<div class="image">','<a href="<%= attrs.liveUrl %>">',"<% if (attrs.O) { %>",'<img itemprop="image" class="thumbnail" src="<%= attrs.O %>">',"<% } else { %>",'<span class="fa fa-user" />',"<% } %>","</a>","</div><!-- /.image -->",'<div class="who">','<h2 itemprop="name"><a href="<%= attrs.liveUrl %>"><%= attrs.title %></a></h2>',"<% if (attrs.P) { %>",'<p itemprop="jobTitle" class="job-title"><% if ((attrs.P).length > 50) { print(attrs.P.substring(0, 50) + \'...\') } else { print(attrs.P); } %></p>',"<% }; %>","</div>",'<div class="meta">',"<% if (attrs.E || attrs.F) { %>",'<p class="business-unit"><span class="fa fa-building-o"></i>',"<% if (attrs.E) { %>",'<a class="filter school" href="#" data-filter-param="E" data-filter-value="<%= $.trim(attrs.E) %>" ','title="Find other staff in <%= $.trim(attrs.E) %>"><%= $.trim(attrs.E) %></a>',"<% } %>","<% if (attrs.F) {%>",'<a class="filter department" href="#" data-filter-param="F" data-filter-value="<%= $.trim(attrs.F).replace("&","&amp;") %>" ','title="Find other staff in <%= $.trim(attrs.F) %>"><%= $.trim(attrs.F) %></a>',"<% } %>","</p><!--.business-unit-->","<% } %>","</div><!-- /.meta -->","</div><!-- /.schema -->"].join("\n"),c=t.ItemView.extend({tagName:"li",className:"academic",template:function(e){return _.template(r,e,{variable:"attrs"})},events:{"click .filter":"filterClick"},filterClick:function(e){var t=$(e.target).data();i(e.target.className+" clicked"),l.router.navigate("search/"+t.filterParam+"/"+encodeURIComponent(t.filterValue).replace(/%20/g,"+").replace(/[()]/g,"\\$&"),{trigger:!0}),e.preventDefault()}}),o=t.CollectionView.extend({el:"#academic-results",itemView:c,firstRender:!0,initialize:function(){this.$el.empty(),this.$el.addClass("loading"),this.$el.addClass("backbone-ready"),this.on("render",this.removeSpinners)},removeSpinners:function(){this.firstRender&&($(".initial-loading-indicator").remove(),this.firstRender=!1),this.$el.removeClass("loading").children(".loading-fa-icon").remove()}}),d=e.View.extend({el:".filters",facetsFound:null,initialize:function(){var e=this;e.listenTo(e.collection,"reset",e.updateSelected),$(function(){e.$filters=e.$el.find(".filter"),e.facetsFound=e.findFacets()})},updateSelected:function(){var e,t;this.$filters.removeClass("selected"),this.collection.fieldFilterRules&&this.collection.fieldFilterRules.length&&(e=this.collection.fieldFilterRules[0].field,t=this.collection.fieldFilterRules[0].value.source,this.$filters.filter("[data-filter-param='"+e+"']").filter("[data-filter-value='"+t+"']").addClass("selected"))},events:{"click .filter":"facetClick"},facetClick:function(e){var t=$(e.target),i="search/"+t.data("filter-param")+"/"+encodeURIComponent(t.data("filter-value")).replace(/%20/g,"+");e.preventDefault(),t.hasClass("selected")?(t.removeClass("selected"),i=""):(this.$el.find(".filter").removeClass("selected"),t.addClass("selected")),l.views.searchboxView.empty(),l.router.navigate(i,{trigger:!0})},findFacets:function(){var e=[];return this.$filters.each(function(){e.push($(this).data("filter-param"))}),_.uniq(e)}}),f=e.View.extend({el:"#fb-queryform",events:{"submit form":"doQuery","click .clear-btn":"clearSearch"},initialize:function(){this.$inputEl=this.$el.find("input"),this.$clearBtn=this.$el.find(".clear-btn"),this.inputWidth=this.$inputEl.width(),this.tfView=l.views.tagFilterView},clearSearch:function(){this.empty(),l.router.navigate("",{trigger:!0})},doQuery:function(e){var t=$.trim(this.$inputEl.val());return e.preventDefault(),0===t.length?void this.clearSearch():(l.views.tagFilterView.removeFilter(),void l.router.navigate("search/query/"+t,{trigger:!0}))},setText:function(e){this.$inputEl.val(e),e.length>0&&this.$clearBtn.removeClass("hidden")},empty:function(){this.$clearBtn.addClass("hidden"),this.$inputEl.val("")},adjustRoom:function(){var e=this.tfView.$el.outerWidth();this.$inputEl.css({"padding-left":e+"px"})}}),u=t.ItemView.extend({el:".tag-filters",events:{click:function(){this.removeFilter(!0)}},template:function(e){return $("<span />",{"class":"tag-filter",title:"click to remove this filter",html:'<span class="fa fa-tag"></i> '+e.value.replace("\\(","(").replace("\\)",")")+'<span class="fa fa-times"></i>'})},removeFilter:function(e){this.$el.empty(),this.trigger("render"),e&&l.router.navigate("",{trigger:!0})}}),h=t.ItemView.extend({el:".results-summary",collectionEvents:{sync:"render",reset:"render",sort:"render"},onRender:function(){p()},template:function(e){return e.info=l.collections.academicsCollection.information,_.template("<span class='results-totals'><%= info.startRecord %> - <%= info.endRecord %> of <%= info.totalRecords %> results</span>",e)}}),m=t.ItemView.extend({el:".load-more",collectionEvents:{sync:"checkIfNeeded",reset:"checkIfNeeded",sort:"checkIfNeeded"},events:{"click .infinite":"showNextPage"},initialize:function(){this.collection.origPerPage=this.collection.paginator_ui.perPage},template:function(e){return _.template("<a class='infinite' href='#'>Show more</a>",e)},checkIfNeeded:function(){this.collection.information.perPage>this.collection.information.totalRecords?this.$el.hide():this.$el.show()},showNextPage:function(e){e.preventDefault();var t,i=this.collection,a=i.information;a.perPage<a.totalRecords&&(t=a.perPage+i.origPerPage,i.howManyPer(t),t>=a.totalRecords&&this.$el.hide())}}),p=function(){var e,t=0;for(t;t<l.collections.academicsCollection.length;t++)e=$("li.academic:eq("+t+")"),t%2===0&&e.addClass("odd")},v=e.Router.extend({routes:{"":"defaultRoute","search/query/:value":"fbSearchRoute","search/:param/:value":"filterRoute"},initialize:function(){$(function(){e.history.start({root:window.location.pathname}),l.collections.academicsCollection.bootstrap()})},defaultRoute:function(){l.collections.academicsCollection.setFieldFilter(),l.views.tagFilterView.removeFilter()},filterRoute:function(t,i){i=$.trim(i).replace(/\+/g," ","gi"),l.collections.academicsCollection.setFieldFilter([{field:t,type:"pattern",value:new RegExp(i)}]),_.contains(l.views.facetsView.facetsFound,t)||(l.views.tagFilterView.model=new e.Model({value:i}),l.views.tagFilterView.render()),l.views.searchboxView.empty()},fbSearchRoute:function(e){l.collections.academicsCollection.searchFunnelback($.trim(e).replace(/\+/g," ")),l.views.searchboxView.setText(e),l.views.tagFilterView.removeFilter(),l.collections.academicsCollection.setFieldFilter()}});l.collections.academicsCollection=new n(appInitialData),l.views.academicsListView=new o({collection:l.collections.academicsCollection}),l.views.facetsView=new d({collection:l.collections.academicsCollection}),l.views.tagFilterView=new u,l.views.searchboxView=new f,l.views.searchMetaView=new h({collection:l.collections.academicsCollection}),l.views.paginationControlsView=new m({collection:l.collections.academicsCollection}),l.router=new v,window.SEARCHAPP=l,$("body").append(a),$(window).scroll(function(){$(this).scrollTop()>100?a.addClass("visible"):a.removeClass("visible")})}(Backbone,Backbone.Marionette);