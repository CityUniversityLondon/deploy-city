CITY.visit=function(e,p){var i=new google.maps.LatLng(51.527761,-.103283),n=p("#map-container"),t={zoom:17,key:"AIzaSyBvg6r1x2ZRKPAsceVaKPlg6tO20QiBDpo",center:i,mapTypeId:google.maps.MapTypeId.ROADMAP,streetViewControl:!0,mapTypeControl:!0,mapTypeControlOptions:{style:google.maps.MapTypeControlStyle.DROPDOWN_MENU},navigationControl:!0},r=new google.maps.Map(document.getElementById("map-canvas"),t),o=p("#map-search"),u=new google.maps.InfoWindow({maxWidth:400}),d={bigMarkersArray:[],bigBuildingsArray:[],buildingsObj:{},buildings:{toggler:null,markersArray:[],zoomLevel:17,list:""},libraries:{toggler:p("#toggle-libraries"),markersArray:[],zoomLevel:17,list:""},accommodation:{toggler:null,markersArray:[],zoomLevel:17,list:""},lectureTheatres:{toggler:null,markersArray:[],zoomLevel:17,list:""},studentCentre:{toggler:p("#toggle-studentCentre"),markersArray:[],zoomLevel:17,list:""},sports:{toggler:null,markersArray:[],zoomLevel:17,list:""},computerLabs:{toggler:p("#toggle-computerLabs"),markersArray:[],zoomLevel:17,list:""}},a={cycleHire:{src:"http://webapps.city.ac.uk/matrix/maps/cycle-hire.php",toggler:p("#cycle-hire"),preserveViewport:!0},bikes:{src:"http://webapps.city.ac.uk/matrix/maps/cycle-parking.kml",toggler:p("#bikes"),preserveViewport:!0},atms:{src:"http://webapps.city.ac.uk/matrix/maps/atms.kml",toggler:p("#cash-points"),preserveViewport:!0}},m=function(e){var n,i=e.getState();p.each(i,function(t,e){"0"!==t?p.each(d.buildingsObj,function(e,i){t===e&&(n=i,function(e){var i;if(e)for(i in e)e.hasOwnProperty(i)&&"function"!=typeof e[i]&&e[i].setMap(null)}(d.bigMarkersArray),n.setVisible(!0),u.setContent(n.infoHtml),u.open(r,n),r.panTo(n.position),n.setMap(r))}):u.close()})},f=function(e){var i={};e&&("string"==typeof e?i[e]=1:e.hasOwnProperty("id")?i[e.id]=1:i[0]=1,p.bbq.pushState(i,2))},h=function(e,i){var t="";return e.children().each(function(){return this.nodeName!=i||(t=p(this).text(),!1)}),t},s=function(e,i,t){var a,s,l={},g=[],c={};p(e).find("item").each(function(){var e,i,t,n,r,o;a=p(this),l.index=1,l.name=a.find("title").text(),l.linkHref=a.find("link").text(),l.description=a.find("description").text(),l.icon=h(a,"CUL:icon"),l.category=a.find("category").text(),l.id=a.find("guid").text(),l.buildingPrefix=h(a,"CUL:buildingPrefix").replace(/^\s+|\s+$/g,""),l.hexColour=h(a,"CUL:hexColour").replace(/^\s+|\s+$/g,""),l.geoLat=h(a,"geo:lat"),l.geoLong=h(a,"geo:long"),l.point=new google.maps.LatLng(parseFloat(l.geoLat),parseFloat(l.geoLong)),r="#"+(e=l).category,o="",o=0!==e.linkHref.length?'<div id="info-window" style="min-height: 100px;"><h3><a href="'+e.linkHref+'">'+e.name+"</a></h3>":'<div id="info-window" style="min-height: 100px;"><h3>'+e.name+"</h3>",0!==e.buildingPrefix.length&&(o+='<p class="building-prefix"><strong>Rooms beginning: '+e.buildingPrefix+"</strong></p>",e.buildingPrefix="("+e.buildingPrefix+")"),o+=e.description+"</div>",(i=new google.maps.Marker({map:e.map,position:e.point,icon:e.icon,animation:google.maps.Animation.DROP})).set("id",e.id),i.set("infoHtml",o),google.maps.event.addListener(i,"click",function(e){return f(i)}),t=p("<li />",{id:"building-"+e.id,class:"building"}),n=p("<a />",{href:"#",html:"<span>"+e.name+" "+e.buildingPrefix+"</span>",click:function(e){return f(p(e.target).parents("li").attr("id").replace("building-","")),!1},css:{background:"transparent url("+e.icon+"?v=1123) no-repeat left center"}}),t.append(n).appendTo(r),s=i,"buildings"!==l.category?d.bigMarkersArray.push(s):d.bigBuildingsArray.push(s),d.buildingsObj[s.id]=s,g.push(l.name),c[l.name]=l.id,d[l.category]?d[l.category].markersArray.push(s):d[l.category]=function(e){this.toggler=null,this.markersArray=[],this.zoomLevel=17}(l.category)}),o.autocomplete({source:g,select:function(e){setTimeout(function(){var e=o.val();o.blur(),e in c&&f(c[e])},0)}}).focusin(function(){o.attr("value","")}),p("#vs-button").click(function(){o.focus()}),google.maps.event.addListener(u,"closeclick",function(){f(u)}),function(e){var i;if(e)for(i in e)e.hasOwnProperty(i)&&"function"!=typeof e[i]&&e[i].setMap(r)}(d.bigBuildingsArray),n.removeClass("loading").children(".loading-fa-icon").remove(),p(window).bind("hashchange",m),p(window).trigger("hashchange")};return{init:function(){var e;n.addClass("loading").append(p('<i class="fa fa-refresh fa-spin loading-fa-icon"></i>')),e=a,p.each(e,function(){var i=this.toggler,t=new google.maps.KmlLayer(this.src,{preserveViewport:this.preserveViewport});i.click(function(e){return i.toggleClass("enabled"),t.setMap(i.hasClass("enabled")?r:null),!1})}),p.ajax({type:"GET",url:"https://www.city.ac.uk/visit/feeds/locations",dataType:"xml",success:s}),p("#filter").accordion({collapsible:!0,autoHeight:!1,clearStyle:!0,active:!1}),p("#journey-link").bind("click",function(e){e.preventDefault(),p("html, body").animate({scrollTop:p("#journey-planner").offset().top},1e3)})},cityLayers:d,infoWindow:u,map:r}}(CITY,jQuery),CITY.visit.init();