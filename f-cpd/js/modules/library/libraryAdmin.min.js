var libraryAdmin=function(e){"use strict";var t,a,n=[],o=[],i=e(".modal"),d=e(".modal--delete"),r=e(".modal__box"),s=e(".modal__box--delete"),l=e(".modal__close"),_=e(".modal__close--delete"),c=e(".admin-calendar"),u=c.attr("data-library-id"),p=c.attr("data-calendar-date")||c.attr("data-today-date"),v=p.split("-")[0],y=p.split("-")[1],f={"Every weekday":"DWD","Every weekend day":"DWE","Every day":"DED","Every week":"WEW"},m=e("#event-template"),h=e(".calendarNavLink"),b=new Squiz_Matrix_API({key:"13123496783452586456"}),x=function(){var e=document.location;e.pathname.search(/\_nocache/)===-1?document.location=e.origin+e.pathname+"/_nocache"+e.search:document.location.reload(!0)},E=function(){var o,i,d,r,s,l;c.find(".eventDate").find(".dateLink").remove(),h.each(function(){e(this).attr("href",e(this).attr("href")+"&root="+u)}),a=c.find(".eventDate"),a.each(function(){o=e(this),i=o.find("[data-id]"),t=i.attr("data-id"),r=i.attr("data-date"),s=i.attr("data-special"),l=i.attr("data-label"),e.inArray(t,n)<0&&n.push(t),o.attr({"data-id":t,"data-date":r,"data-special":s,"data-label":l}),d=n.length;for(var a=0;a<d;a++)e("[data-id='"+n[a]+"']").parents(".eventDate").addClass("event--"+(a+1));i.removeAttr("data-id data-date data-special data-label")}),e(".calendar").removeClass("calendar--loading")},D=function(){a.hover(function(){t=e(this).attr("data-id"),e("[data-id='"+t+"']").addClass("hover")},function(){e("[data-id='"+t+"']").removeClass("hover")}),e(".unused").hover(function(){e(this).addClass("hover")},function(){e(this).removeClass("hover")}),c.find(".date").click(function(a){var n=e(this),o="";return e(a.target).hasClass("event__add-exception")?void C("new modification",n.attr("data-date").split(" ")[0]):n[0].hasAttribute("data-id")?(t=e(this).attr("data-id"),void C(t,void 0)):(o=n.find(".dateLink").html(),void C(void 0,parseInt(o)<10?"0"+o:o))})},k=function(){g();var e=document.getElementById("modal__box__special");e.addEventListener("change",function(){g()})},g=function(){"closed"===e("#modal__box__special").val()||"open24hours"===e("#modal__box__special").val()?e("#modal__box__times select").prop("disabled",!0):e("#modal__box__times select").prop("disabled",!1)},T=function(){_.click(function(){M()}),l.click(function(){w()}),e(document).keyup(function(e){27===e.keyCode&&(d.hasClass("active")?M():i.hasClass("active")&&w())}),r.on("click",function(a){var n=e(a.target);a.preventDefault(),n.hasClass("modal__box__submit")&&(r.addClass("modal__box--loading"),r.off("click"),W()),n.hasClass("modal__box__delete")&&(r.off("click"),A(t))}),s.on("click",function(a){e(a.target).hasClass("modal__box__delete-confirm")&&(a.preventDefault(),j(t))})},C=function(a,n){void 0===a?L(n,!1,null):"new modification"===a?L(n,!0,t):q(a),i.addClass("active"),e("[data-id='"+t+"']").removeClass("hover"),e("[data-id='"+t+"']").attr("aria-selected",!0)},w=function(){i.removeClass("active"),e("[data-id='"+t+"']").removeAttr("aria-selected")},A=function(t){e(".modal__box__delete-confirm").prop("disabled",!0);var a,n=new XMLHttpRequest,i="//www.city.ac.uk/api/library-opening-times/delete-event-children?root="+t,r={};n.open("GET",i,!0),n.onreadystatechange=function(){4===this.readyState&&(this.status>=200&&this.status<400?(a=JSON.parse(this.responseText),Object.keys(a.children).length>0&&J(a),setTimeout(function(){e(".modal__box__delete-confirm").prop("disabled",!1)},500),o.push(t)):r={error:!0})},n.send(),n=null,d.addClass("active")},M=function(){d.removeClass("active")},I=function(){H();var e=document.getElementById("modal__box__start-day");e.addEventListener("change",function(){H()})},H=function(){var t,a,n;t=e("#modal__box__start-day").val(),a=e("#modal__box__end-day").val(),n=e("#modal__box__start-day option").length,parseInt(a,10)<parseInt(t,10)&&e("#modal__box__end-day option").filter(function(){return e(this).text()==t}).prop("selected",!0),e("#modal__box__end-day option").prop("disabled",!1);for(var o=1;o<=n;o++)o<parseInt(t,10)&&e("#modal__box__end-day option:nth-child("+o+")").prop("disabled",!0)},N=function(){O();var e=document.getElementById("modal__box__start-hour");e.addEventListener("change",function(){O()})},O=function(){var t,a,n;t=e("#modal__box__start-hour").val(),a=e("#modal__box__end-hour").val(),n=e("#modal__box__start-hour option").length,parseInt(a,10)<parseInt(t,10)&&0!=parseInt(a,10)&&e("#modal__box__end-hour option").filter(function(){return e(this).text()==t}).prop("selected",!0),e("#modal__box__end-hour option").prop("disabled",!1);for(var o=2;o<=n;o++)o<=parseInt(t,10)&&e("#modal__box__end-hour option:nth-child("+o+")").prop("disabled",!0)},q=function(e){R(e)},L=function(e,t,a){var n={startDay:e,endDay:"",startHour:"",startMonth:y,startYear:v,startMinute:"",duration:"",endDay:"",endHour:"",endMinute:"",frequency:"",frequencyIcal:"",label:"",modification:t,specialTime:"",weekdays:!1,weekends:!1,legendText:"You are creating a new Event.",eventType:"new",deleteButton:!1,eventTypeToCreate:t===!0?"calendar_event_modification":"calendar_event_recurring",parentModificationId:t===!0?a:""},o=S(m.html(),n,n.parentModificationId);P(o)},R=function(e){var t;t="",t+=S(m.html(),libraryData[e],e),P(t)},S=function(e,t,a){for(var n="",o="",i="",d="",r="",s="",l="",_="",c="",u="",v="",y="",f="",m=t.modification,h=["January","February","March","April","May","June","July","August","September","October","November","December"],b=["01","02","03","04","05","06","07","08","09","10","11","12","13","14","15","16","17","18","19","20","21","22","23","24","25","26","27","28","29","30","31"],x=["00","01","02","03","04","05","06","07","08","09","10","11","12","13","14","15","16","17","18","19","20","21","22","23"],E=["00","01","02","03","04","05","06","07","08","09","10","11","12","13","14","15","16","17","18","19","20","21","22","23","24","25","26","27","28","29","30","31","32","33","34","35","36","37","38","39","40","41","42","43","44","45","46","47","48","49","50","51","52","53","54","55","56","57","58","59"],D={"":"None",closed:"Closed",open24hours:"Open 24 Hours"},k={"":"None","bank-holiday":"Bank Holiday","christmas-holiday":"Christmas Holiday","easter-holiday":"Easter Holiday","exam-period":"Exam Period"},g={"Every day":"Every Day","Every week":"Once a Week","Every weekday":"Every Weekday","Every weekend day":"Every Weekend"},T=B(t.startYear,t.startMonth),C=h[parseInt(p.split("-")[1])-1],w=p.split("-")[0],A=0;A<T;A++)n+=b[A]===t.startDay?"<option selected>"+b[A]+"</option>":"<option>"+b[A]+"</option>",d+=b[A]===t.endDay?"<option selected>"+b[A]+"</option>":"<option>"+b[A]+"</option>";for(var A=0;A<x.length;A++)o+=x[A]===t.startHour?"<option selected>"+x[A]+"</option>":"<option>"+x[A]+"</option>",r+=x[A]===t.endHour?"<option selected>"+x[A]+"</option>":"<option>"+x[A]+"</option>";for(var A=0;A<E.length;A++)i+=E[A]===t.startMinute?"<option selected>"+E[A]+"</option>":"<option>"+E[A]+"</option>",s+=E[A]===t.endMinute?"<option selected>"+E[A]+"</option>":"<option>"+E[A]+"</option>";for(var M in D)D.hasOwnProperty(M)&&(l+=M===t.specialTime?'<option value="'+M+'" selected>'+D[M]+"</option>":'<option value="'+M+'">'+D[M]+"</option>");for(var M in k)k.hasOwnProperty(M)&&(_+=M===t.label?'<option value="'+M+'" selected>'+k[M]+"</option>":'<option value="'+M+'">'+k[M]+"</option>");if(m)u="You are editing an exception.",v="exception",c+='<option value="never" selected>never</option>';else{for(var M in g)g.hasOwnProperty(M)&&(c+=M===t.frequency?'<option value="'+M+'" selected>'+g[M]+"</option>":'<option value="'+M+'">'+g[M]+"</option>");u=t.legendText||"You are editing an existing event.",v=t.eventType||"existing",e=Y(e,d,"@@END_DAY@@")}return t.deleteButton&&(y='<button class="modal__box__delete"><i class="fa  fa-times"></i>Delete Event</button>'),f=""===a?"":a,e=Y(e,t.eventTypeToCreate,"@@ASSET_TYPE@@"),e=Y(e,v,"@@EVENTTYPE@@"),e=Y(e,u,"@@LEGEND@@"),e=Y(e,n,"@@START_DAY@@"),e=Y(e,C+" "+w,"@@MONTH_YEAR@@"),e=Y(e,w,"@@YEAR@@"),e=Y(e,C,"@@MONTH@@"),e=Y(e,o,"@@START_HOUR@@"),e=Y(e,i,"@@START_MINUTE@@"),e=Y(e,r,"@@END_HOUR@@"),e=Y(e,s,"@@END_MINUTE@@"),e=Y(e,c,"@@RECURRENCE@@"),e=Y(e,y,"@@DELETE_BUTTON@@"),e=Y(e,f,"@@EVENT_ID@@"),e=Y(e,l,"@@SPECIAL@@"),e=Y(e,_,"@@LABEL@@")},Y=function(e,t,a){var n=new RegExp(a,"g");return e.replace(n,t)},P=function(e){r.html(e),I(),N(),k()},B=function(e,t){for(var a=new Date(e,t-1,1),n=[];a.getMonth()===t-1;)n.push(a.getDate()),a.setDate(a.getDate()+1);return n.length},W=function(){var t,a,n={assetid:e(".modal__box__event-id").val(),startDay:e(".modal__box__start-day").val(),endDay:e(".modal__box__end-day").val(),startHours:e(".modal__box__start-hour").val(),startMinutes:e(".modal__box__start-minute").val(),endHours:e(".modal__box__end-hour").val(),endMinutes:e(".modal__box__end-minute").val(),specialOpen:e(".modal__box__special").val(),specialPeriod:e(".modal__box__label").val(),frequency:e(".modal__box__recurrence").val(),assetType:e(".modal__box__event-asset-type").val()};"undefined"===n.assetType?U(n,void 0):(t=e(".modal__box__year").val()+" "+e(".modal__box__month").val()+" "+n.startDay,n.endDay!==n.startDay&&(t+=" - "+n.endDay,"Every week"===n.frequency?t+=" (weekly)":"Every weekday"===n.frequency?t+=" (weekdays)":"Every weekend"===n.frequency&&(t+=" (weekends)")),a="frequency="+f[n.frequency],a+="&stop_date="+v+"-"+y+"-"+n.endDay,a+="&start_date="+v+"-"+y+"-"+n.startDay,b.createAsset({parent_id:"calendar_event_recurring"===n.assetType?parseInt(u):parseInt(n.assetid),type_code:n.assetType,asset_name:t,link_type:1,link_value:"",sort_order:1,is_dependant:0,is_exclusive:0,extra_attributes:1,attributes:a,dataCallback:function(e){U(n,e.id)}}))},U=function(e,t){var a=t||e.assetid;b.setMultipleAttributes({asset_id:a,field_info:{start_date:v+"-"+y+"-"+e.startDay,stop_date:v+"-"+y+"-"+e.endDay,frequency:f[e.frequency]},dataCallback:function(){b.setMetadataAllFields({asset_id:a,field_info:{287178:v+"-"+y+"-"+e.startDay+" "+e.startHours+":"+e.startMinutes+":00",287179:v+"-"+y+"-"+(null===e.endDay?e.startDay:e.endDay)+" "+e.endHours+":"+e.endMinutes+":00",288411:e.specialOpen,288145:e.specialPeriod,290106:null===e.endDay||e.startDay===e.endDay},dataCallback:function(e){b.setAssetStatus({asset_id:a,status:16,cascade:0,dataCallback:function(){x()}})}})}})},J=function(t){for(var a,n=e(".modal__box--delete__exceptions__list"),i=1;i<=Object.keys(t.children).length;i++)a=t.children[i],n.append('<li data-id="'+a.id+'">'+a.startDay+" "+a.times+"</li>"),o.push(a.id);e(".modal__box--delete__exceptions").css("display","block")},j=function(e){b.setAssetStatus({asset_id:e,status:2,cascade:1,dataCallback:function(){b.trashAsset({asset_ids:[e],dataCallback:function(){x()}})}})},F=function(){E(),D(),T()},G={init:F};return G}(jQuery);libraryAdmin.init();