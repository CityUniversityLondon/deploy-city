CITY.library=function(e){"use strict";var t=e(".library-search"),a=t.find(".dropdown-select"),n=a.find(".display"),i=n.find("span"),s=t.find(".search-refine-wrapper input"),r=e("[data-library-id]").length,d=e(".opening-times-navigation .calendarNavLink"),o=e(".opening-times-panel--left > h3"),l=["monday","tuesday","wednesday","thursday","friday","saturday","sunday"],p=function(t){var a=e(t.target).prop("selectedIndex");s.prop("checked",!1),s.eq(a).prop("checked",!0)},m=function(t){var n,r,d,o=e(t.target);t.preventDefault(),a.toggleClass("active"),o.hasClass("option")&&(n=o.attr("data-value"),d=o.index(),r=o.html(),s.prop("checked",!1),s.eq(d).prop("checked",!0),i.html(r),a.removeClass("active"))},c=function(e,t){return new Date(e.getTime()+24*t*60*60*1e3)},u=function(e){var t=e.getDate(),a=e.getMonth()+1,n=e.getFullYear();return t<10&&(t="0"+t),a<10&&(a="0"+a),n+"-"+a+"-"+t},y=function(e){var t={0:"Jan",1:"Feb",2:"Mar",3:"Apr",4:"May",5:"Jun",6:"Jul",7:"Aug",8:"Sep",9:"Oct",10:"Nov",11:"Dec"};return t[e.getMonth()]},h=function(e){return e.charAt(0).toUpperCase()+e.slice(1)},g=function(e){var t,a=new XMLHttpRequest,n=e.week||"",i="//www.city.ac.uk/api/library-opening-times/current-week/_nocache?SQ_CALENDAR_VIEW=week&SQ_CALENDAR_DATE="+n,s={};a.open("GET",i,!0),a.onreadystatechange=function(){4===this.readyState&&(this.status>=200&&this.status<400?(t=JSON.parse(this.responseText),v({data:t,todayClean:t.todayClean,todayDay:t.todayDay,queryWeek:t.queryWeek,updateElements:e.updateElements})):s={error:!0})},a.send(),a=null,e.updateElements.addClass("opening-times-busy")},f=function(t,a){a.each(function(){for(var a,n,i,s,r,d,o,p,m,g,f,v,b,C,k,D=e(this),T=D.attr("data-library-id"),E=t.data.libraries[T],A=(E.times,D.find(".opening-times-list-card .opening-times-panel--left .opening-times-table tbody")),w="",_="",N=0;N<l.length;N++)E.times[l[N]]?(a=E.times[l[N]],n=a.special,i=a.date,s=a.dateClean.split(",",1),r=a.startTime,d=a.endTime,o=a.isToday,w+=o?'<tr data-date="'+s+'" class="is-today">':'<tr data-date="'+s+'">',w+="<td><span>"+h(l[N])+"</span></td>",w+="<td>",w+="closed"===n?"<span><em>Closed</em></span>":"open24hours"===n?"<span><em>Open 24 hours</em></span>":'<time datetime="'+i+"T"+r.replace(".",":")+'">'+r+'</time><span> &ndash; </span><time datetime="'+i+"T"+d.replace(".",":")+'">'+d+"</time>",w+="</td>",w+="</tr>"):(w+="<tr>",w+="<td><span>"+h(l[N])+"</span></td>",w+="<td><span>No time availalble</span></td>",w+="</tr>");""!==t.queryWeek?(p=t.queryWeek.split("-"),m=new Date(p[0],p[1]-1,p[2]),g=c(m,6),f=m.getDate()+" "+y(m)+" until "+g.getDate()+" "+y(g),v=c(m,7),b=u(v),C=c(m,-7),k=u(C),D.find(".opening-times-navigation-previous a").attr("href","?SQ_CALENDAR_VIEW=week&SQ_CALENDAR_DATE="+k),D.find(".opening-times-navigation-next a").attr("href","?SQ_CALENDAR_VIEW=week&SQ_CALENDAR_DATE="+b),_=f):_=t.data.currentWeekRange,D.find(".opening-times-navigation-date-range time").text(_).attr("data-toggle","on"),A.html(w),D.removeClass("opening-times-busy")})},v=function(t){var a,n,i,s,r,d,o=e("[data-times-type=daily]"),l=e("[data-times-type=weekly]"),p=e("[data-times-type=call-to-action]"),m="",c="",u=t.updateElements;return o.length>0?void u.each(function(){var a=e(this),o=a.attr("data-library-id"),l=t.data.libraries[o],p=l.times[t.todayDay];i=p.special,s=p.date,r=p.startTime,d=p.endTime,e(".opening-times--home-controls h2 a time").html(t.todayClean),n=a.find(".opening-times--home-list-item-times"),m="closed"===i?"<span><em>Closed</em></span>":"open24hours"===i?"<span><em>Open 24 hours</em></span>":'<time datetime="'+s+"T"+r.replace(".",":")+'">'+r+'</time><span> &ndash; </span><time datetime="'+s+"T"+d.replace(".",":")+'">'+d+"</time>",n.html(m),a.removeClass("opening-times-busy")}):l.length>0?void f(t,u):void(p.length>0&&u.each(function(){var o,l,p=e(this),u=p.find(".library-aside-call-to-action-subtitle");a=p.attr("data-library-id"),o=t.data.libraries[a],l=o.times[t.todayDay],i=l.special,s=l.date,r=l.startTime,d=l.endTime,n=p.find(".library-aside-call-to-action-title"),"closed"===i?m="Closed":(m="Open",c="open24hours"===i?"24 hours":'until <time datetime="'+s+"T"+d.replace(".",":")+'">'+d+"</time>"),m+=" Today",n.html(m),u.html(c),p.removeClass("opening-times-busy")}))},b=function(){o.remove(),a.on("click",m),e(".library-search__content-type").change(p),0!==r&&(g({week:"",updateElements:e("[data-times-type]")}),d.on("click",function(t){var a=e(this),n=a.attr("href").split("=")[2],i=a.parents("[data-times-type]");i.hasClass("opening-times-busy")||g({week:n,updateElements:i}),t.preventDefault()}))};return{init:b}}($),CITY.library.init();