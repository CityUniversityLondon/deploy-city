!function(i,e){function a(e){CITY.debug(e)}var l={collections:{academicsCollection:void 0},views:{academicsListView:void 0,facetsView:void 0},router:void 0},t=i.Model.extend({}),n=Backbone.Paginator.clientPager.extend({model:t,initialize:function(){this.on("all",function(e){a("academics collection event fired: "+e)})},paginator_core:{dataType:"json",url:"/fb/search.json"},paginator_ui:{perPage:20},server_api:{collection:"academics-matrix",landing:"true",sort:"metaR"},parse:function(e){var t=[];return e.response&&e.response.resultPacket&&_.each(e.response.resultPacket.results,function(e){var i={};_.each(e,function(e,t){if(_.isObject(e))_.each(e,function(e,t){i[t]=e});else if(_.isArray(e)){if(!e.length)return;i[t]=e}else i[t]=e}),t.push(i)}),t},searchFunnelback:function(e){var t,i=this.server_api,a=this;delete i.sort,t=decodeURIComponent($.param(_.extend(i,{query:e}))),this.fetch({success:function(){a.sortedAndFilteredModels=a.models.slice(),a.info()},data:t})}}),s=['<div class="image">','<a href="<%= attrs.liveUrl %>">',"<% if (attrs.O) { %>",'<img class="thumbnail" src="<%= attrs.O %>">',"<% } else { %>",'<i class="fa fa-user" />',"<% } %>","</a>","</div>\x3c!-- /.image --\x3e",'<div class="who">','<h2><a href="<%= attrs.liveUrl %>"><%= attrs.title %></a></h2>',"<p class=\"job-title\"><% if ((attrs.P).length > 50) { print(attrs.P.substring(0, 50) + '...') } else { print(attrs.P); } %></p>","</div>",'<div class="meta">',"<% if (attrs.E || attrs.F) { %>",'<p class="business-unit"><i class="fa fa-building-o"></i>',"",'<% if (attrs.F) { _.each(attrs.F.split(","), function (dept) { dept = $.trim(dept); %>',"<% if (!dept) return; %>",'<a class="filter department" href="#" data-filter-param="F" data-filter-value="<%= dept %>" ','title="Find other staff in <%= dept %>"><%= dept %></a>',"<% }); } %>","</p>\x3c!--.business-unit--\x3e","<% } %>","</div>\x3c!-- /.meta --\x3e"].join("\n"),c=e.ItemView.extend({tagName:"li",className:"academic",template:function(e){return _.template(s,e,{variable:"attrs"})},events:{"click .filter":"filterClick"},filterClick:function(e){var t=$(e.target).data();a(e.target.className+" clicked"),l.router.navigate("search/"+t.filterParam+"/"+encodeURIComponent(t.filterValue).replace(/%20/g,"+"),{trigger:!0}),e.preventDefault()}}),r=e.CollectionView.extend({el:"#academic-results",itemView:c,firstRender:!0,initialize:function(){this.$el.addClass("loading"),this.$el.empty(),this.$el.addClass("backbone-ready"),this.on("render",this.removeSpinners)},removeSpinners:function(){this.firstRender&&($(".initial-loading-indicator").remove(),this.firstRender=!1),this.$el.removeClass("loading")}}),o=i.View.extend({el:".filters",facetsFound:null,initialize:function(){var e=this;e.listenTo(e.collection,"reset",e.updateSelected),$(function(){e.$filters=e.$el.find(".filter"),e.facetsFound=e.findFacets()})},updateSelected:function(){var e,t;this.$filters.removeClass("selected"),this.collection.fieldFilterRules&&this.collection.fieldFilterRules.length&&(e=this.collection.fieldFilterRules[0].field,t=this.collection.fieldFilterRules[0].value.source,this.$filters.filter("[data-filter-param='"+e+"']").filter("[data-filter-value='"+t+"']").addClass("selected"))},events:{"click .filter":"facetClick"},facetClick:function(e){var t=$(e.target),i="search/"+t.data("filter-param")+"/"+encodeURIComponent(t.data("filter-value")).replace(/%20/g,"+");e.preventDefault(),t.hasClass("selected")?(t.removeClass("selected"),i=""):(this.$el.find(".filter").removeClass("selected"),t.addClass("selected")),l.views.searchboxView.empty(),l.router.navigate(i,{trigger:!0})},findFacets:function(){var e=[];return this.$filters.each(function(){e.push($(this).data("filter-param"))}),_.uniq(e)}}),d=i.View.extend({el:"#fb-queryform",events:{"submit form":"doQuery"},initialize:function(){this.$inputEl=this.$el.find("input"),this.inputWidth=this.$inputEl.width(),this.tfView=l.views.tagFilterView},doQuery:function(e){var t=$.trim(this.$inputEl.val());e.preventDefault(),a("search requested for "+t),0!==t.length&&(l.views.tagFilterView.removeFilter(),l.router.navigate("search/query/"+t,{trigger:!0}))},setText:function(e){this.$inputEl.val(e)},empty:function(){this.$inputEl.val("")}}),f=e.ItemView.extend({el:".tag-filters",events:{click:function(){this.removeFilter(!0)}},template:function(e){return $("<span />",{class:"tag-filter",title:"click to remove this filter",html:"tag: "+e.value+"<i class='fa fa-times'></i>"})},removeFilter:function(e){this.$el.empty(),this.trigger("render"),e&&l.router.navigate("",{trigger:!0})}}),u=e.ItemView.extend({el:".results-summary",collectionEvents:{sync:"render",reset:"render",sort:"render"},onRender:function(){!function(){for(var e=0;e<l.collections.academicsCollection.length;e++)e%2==0&&$("li.academic:eq("+e+")").addClass("odd")}()},template:function(e){return e.info=l.collections.academicsCollection.information,_.template("<span class='results-totals'><%= info.startRecord %> - <%= info.endRecord %> of <%= info.totalRecords %> results</span>",e)}}),h=e.ItemView.extend({el:".read-more",collectionEvents:{sync:"checkIfNeeded",reset:"checkIfNeeded",sort:"checkIfNeeded"},events:{"click .infinite":"showNextPage"},initialize:function(){this.collection.origPerPage=this.collection.paginator_ui.perPage},template:function(e){return _.template("<a class='infinite' href='#'>Show more</a>",e)},checkIfNeeded:function(){this.collection.information.perPage>this.collection.information.totalRecords?this.$el.hide():this.$el.show()},showNextPage:function(e){e.preventDefault();var t,i=this.collection,a=i.information;a.perPage<a.totalRecords&&(t=a.perPage+i.origPerPage,i.howManyPer(t),t>=a.totalRecords&&this.$el.hide())}}),m=i.Router.extend({routes:{"":"defaultRoute","search/query/:value":"fbSearchRoute","search/:param/:value":"searchRoute"},initialize:function(){l.collections.academicsCollection.once("sync",function(){a("starting router"),$(function(){i.history.start({root:window.location.pathname})})}),l.collections.academicsCollection.fetch({success:function(){l.collections.academicsCollection.pager()},silent:!0})},defaultRoute:function(){l.collections.academicsCollection.setFieldFilter(),l.views.tagFilterView.removeFilter()},searchRoute:function(e,t){t=$.trim(t).replace(/\+/g," ","gi"),l.collections.academicsCollection.setFieldFilter([{field:e,type:"pattern",value:new RegExp(t)}]),_.contains(l.views.facetsView.facetsFound,e)||(l.views.tagFilterView.model=new i.Model({value:t}),l.views.tagFilterView.render()),l.views.searchboxView.empty()},fbSearchRoute:function(e){l.collections.academicsCollection.searchFunnelback($.trim(e).replace(/\+/g," ")),l.views.searchboxView.setText(e),l.views.tagFilterView.removeFilter()}});l.collections.academicsCollection=new n,l.views.academicsListView=new r({collection:l.collections.academicsCollection}),l.views.facetsView=new o({collection:l.collections.academicsCollection}),l.views.tagFilterView=new f,l.views.searchboxView=new d,l.views.searchMetaView=new u({collection:l.collections.academicsCollection}),l.views.paginationControlsView=new h({collection:l.collections.academicsCollection}),l.router=new m,window.SEARCHAPP=l}(Backbone,Backbone.Marionette);