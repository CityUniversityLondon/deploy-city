var libraryAdmin=function(e){"use strict";var a,t,s,n,r,i,d=[],l=e(".add-exception"),o=e(".start-full-date"),c=e(".open-status"),p=e("#notice-text").attr("data-libraryid");return{init:function(){d.key="1319678258",a=new Squiz_Matrix_API(d),l.click(function(){var a=e(this);a.siblings(".open-date").toggleClass("exception-container"),a.siblings(".closed-date").toggleClass("exception-container"),a.toggleClass("add-exception-show")}),c.change(function(){var a=e(this),t=a.parent(".recurring-container"),s=a.parents(".edit-opening-times-item");"open"===a.val()?(s.children(".closed-date").addClass("hide"),s.children(".open-date").removeClass("hide"),t.removeClass("recurring-closed").addClass("recurring-open"),t.children(".day-details").removeClass("hide")):"twentyfour"===a.val()?(s.children(".closed-date").addClass("hide"),s.children(".open-date").removeClass("hide"),t.removeClass("recurring-closed").addClass("recurring-open"),t.children(".day-details").addClass("hide")):(s.children(".closed-date").removeClass("hide"),s.children(".open-date").addClass("hide"),t.removeClass("recurring-open").addClass("recurring-closed"),t.children(".day-details").addClass("hide"))}),e(".recurring-container .action-button").click(function(){var t,s,n,r,i=[],d=e(this),l=d.parents(".edit-opening-times-item"),o=l.children(".recurring-container"),c=o.find(".open-status"),p=o.attr("id");d.fadeOut("slow"),l.find(".ajax-loader").fadeIn("slow"),o.siblings(".admin-error").remove(),"close"===c.val()?(l.find(".open-exceptions li").each(function(a){i[a]=e(this).attr("id")}),a.trashAsset({asset_ids:i,dataCallback:function(){a.setAssetStatus({asset_id:p,status:2,cascade:0,dataCallback:function(e){e.error&&o.after("<p class='admin-error'>There was an error changing the status of the library to 'closed' for this day. Please try again.</p>").hide().show("slow"),l.find(".ajax-loader").fadeOut("slow"),d.fadeIn("slow")}})}})):(s=(r=l.find(".year, .month, .day, .day-details .open-start-hours, .day-details .open-start-minutes, .day-details .open-end-hours, .day-details .open-end-minutes"))[0].textContent+"-"+r[1].textContent+"-"+r[2].textContent+" "+r[3].value+":"+r[4].value+":00",n=r[0].textContent+"-"+r[1].textContent+"-"+r[2].textContent+" "+r[5].value+":"+r[6].value+":00",t="twentyfour"===c.val()?"yes":"no",a.setMetadataAllFields({asset_id:p,field_info:{123000:s,123001:n,127109:t},dataCallback:function(t){t.success||o.after("<p class='admin-error'>There was an error updating the times for this day. Please try again.</p>").hide().show("slow"),a.setAssetStatus({asset_id:p,status:16,cascade:0,dataCallback:function(){l.find(".closed-exceptions li").each(function(a){i[a]=e(this).attr("id")}),a.trashAsset({asset_ids:i,dataCallback:function(){l.find(".ajax-loader").fadeOut("slow"),d.fadeIn("slow")}})}})}}))}),e(".change-exception").click(function(){var r,i,d,l=e(this),o=l.parent(".open-change-exception"),c=l.parents(".edit-opening-times-item"),p=o.find(".start-full-date, .start-hours, .start-minutes, .end-hours, .end-minutes"),u=o.parent(".open-date").siblings(".recurring-open").children(".week-day").text(),f=o.children(".24h-selector").is(":checked");l.fadeOut("slow"),c.find(".ajax-loader").fadeIn("slow"),c.find(".admin-error").remove(),d=!0===f?"yes":"no",r=e(p[0]).val().split("-")[2]+"-"+e(p[0]).val().split("-")[1]+"-"+e(p[0]).val().split("-")[0],n=r+" "+e(p[1]).val()+":"+e(p[2]).val()+":00",i=r+" "+e(p[3]).val()+":"+e(p[4]).val()+":00",t="start_date="+r,a.createAsset({parent_id:o.parents(".edit-opening-times-item").find(".recurring-container").attr("id"),type_code:"calendar_event_modification",asset_name:u,link_type:1,link_value:"",sort_order:1,is_dependant:0,is_exclusive:0,extra_attributes:1,attributes:t,dataCallback:function(t){t.error?(c.append("<p class='admin-error'>There was an error creating this exception. Please try again.</p>"),o.children(".start-full-date").val("dd-mm-yyyy"),c.find(".ajax-loader").fadeOut("slow"),l.fadeIn("slow")):a.setMetadataAllFields({asset_id:t.id,field_info:{123000:n,123001:i,127109:d},dataCallback:function(n){n.success?a.setAssetStatus({asset_id:t.id,status:16,cascade:0,dataCallback:function(n){n.error?(a.trashAsset({asset_ids:t.id}),c.append("<p class='admin-error'>There was an error creating this exception, please try again. <br />(note for developer: status change error, asset "+t.id+" created and moved to trash)</p>")):(s=!1===f?'<li id="'+t.id+'" class="exception-item"><span class="event-container add-event">Opened on '+u.substring(0,u.length-1)+' <span class="open-full-day">'+e(p[0]).val()+'</span><span class="extra-content"> from </span><span class="open-start">'+e(p[1]).val()+":"+e(p[2]).val()+'</span><span class="extra-content"> to </span><span class="open-end">'+e(p[3]).val()+":"+e(p[4]).val()+'</span></span><span class="remove-date"> remove</span></li>':'<li id="'+t.id+'" class="exception-item"><span class="event-container add-event">Opened on '+u.substring(0,u.length-1)+' <span class="open-full-day">'+e(p[0]).val()+'</span><span class="extra-content"> for 24 hours</span><span class="remove-date"> remove</span></li>',o.siblings(".open-exceptions").append(s).hide().fadeIn("slow")),o.children(".start-full-date").val("dd-mm-yyyy"),c.find(".ajax-loader").fadeOut("slow"),l.fadeIn("slow")}}):(a.trashAsset({asset_ids:t.id}),c.append("<p class='admin-error'>There was an error creating this exception, please try again. <br />(note for developer: metadata set error, asset "+t.id+" created and moved to trash)</p>"),o.children(".start-full-date").val("dd-mm-yyyy"),c.find(".ajax-loader").fadeOut("slow"),l.fadeIn("slow"))}})}})}),e(".close-exception").click(function(){var r=e(this),i=r.parent(".open-del-exception"),d=i.find(".start-full-date"),l=r.parents(".edit-opening-times-item"),o=i.parent(".open-date").siblings(".recurring-open").children(".week-day").text();r.fadeOut("slow"),l.find(".ajax-loader").fadeIn("slow"),l.find(".admin-error").remove(),n=d.val().split("-")[2]+"-"+d.val().split("-")[1]+"-"+d.val().split("-")[0],t="start_date="+n,a.createAsset({parent_id:i.parents(".edit-opening-times-item").find(".recurring-container").attr("id"),type_code:"calendar_event_cancellation",asset_name:o,link_type:1,link_value:"",sort_order:1,is_dependant:0,is_exclusive:0,extra_attributes:1,attributes:t,dataCallback:function(e){e.error?(l.append("<p class='admin-error'>There was an error creating this exception. Please try again.</p>"),i.children(".start-full-date").val("dd-mm-yyyy"),l.find(".ajax-loader").fadeOut("slow"),r.fadeIn("slow")):a.setAssetStatus({asset_id:e.id,status:16,cascade:0,dataCallback:function(t){t.error?(a.trashAsset({asset_ids:e.id}),l.append("<p class='admin-error'>There was an error creating this exception, please try again. <br />(note for developer: status change error, asset "+e.id+" created and moved to trash)</p>")):(s='<li id="'+e.id+'" class="exception-item"><span class="event-container add-event">Closed on '+o.substring(0,o.length-1)+' <span class="open-full-day">'+n+'</span></span><span class="remove-date"> remove</span></li>',i.siblings(".open-exceptions").append(s).hide().fadeIn("slow")),i.children(".start-full-date").val("dd-mm-yyyy"),l.find(".ajax-loader").fadeOut("slow"),r.fadeIn("slow")}})}})}),e(".open-exception").click(function(){var d=e(this),l=d.parents(".edit-opening-times-item"),o=d.parent(".closed-create-exception"),c=o.find(".start-full-date, .start-hours, .start-minutes, .end-hours, .end-minutes"),p=o.parent(".closed-date").siblings(".recurring-closed").children(".week-day").text();d.fadeOut("slow"),l.find(".ajax-loader").fadeIn("slow"),l.find(".admin-error").remove(),r=e(c[0]).val().split("-")[2]+"-"+e(c[0]).val().split("-")[1]+"-"+e(c[0]).val().split("-")[0],n=r+" "+e(c[1]).val()+":"+e(c[2]).val()+":00",i=r+" "+e(c[3]).val()+":"+e(c[4]).val()+":00",t="start_date="+n+"&end_date="+i,a.createAsset({parent_id:o.parents(".edit-opening-times-item").find(".recurring-container").attr("id"),type_code:"calendar_event_single",asset_name:p,link_type:1,link_value:"",sort_order:1,is_dependant:0,is_exclusive:0,extra_attributes:1,attributes:t,dataCallback:function(t){t.error?(l.append("<p class='admin-error'>There was an error creating this exception. Please try again.</p>"),o.children(".start-full-date").val("dd-mm-yyyy"),l.find(".ajax-loader").fadeOut("slow"),d.fadeIn("slow")):a.setMetadataAllFields({asset_id:t.id,field_info:{123000:n,123001:i},dataCallback:function(n){n.error?(a.trashAsset({asset_ids:t.id}),l.append("<p class='admin-error'>There was an error creating this exception, please try again. <br />(note for developer: metadata set error, asset "+t.id+" created and moved to trash)</p>"),o.children(".start-full-date").val("dd-mm-yyyy"),l.find(".ajax-loader").fadeOut("slow"),d.fadeIn("slow")):a.setAssetStatus({asset_id:t.id,status:16,cascade:0,dataCallback:function(n){n.error?(a.trashAsset({asset_ids:t.id}),l.append("<p class='admin-error'>There was an error creating this exception, please try again. <br />(note for developer: status change error, asset "+t.id+" created and moved to trash)</p>")):(s='<li id="'+t.id+'" class="exception-item"><span class="event-container add-event">Opened on '+p.substring(0,p.length-1)+' <span class="open-full-day">'+e(c[0]).val()+'</span><span class="extra-content"> from </span><span class="open-start">'+e(c[1]).val()+":"+e(c[2]).val()+'</span><span class="extra-content"> to </span><span class="open-end">'+e(c[3]).val()+":"+e(c[4]).val()+'</span></span><span class="remove-date"> remove</span></li>',o.siblings(".closed-exceptions").append(s).hide().fadeIn("slow")),o.children(".start-full-date").val("dd-mm-yyyy"),l.find(".ajax-loader").fadeOut("slow"),d.fadeIn("slow")}})}})}})}),e(".remove-date").live("click",function(){var t=e(this),s=t.parents(".edit-opening-times-item"),n=t.parent(".exception-item");t.fadeOut("slow"),s.find(".ajax-loader").fadeIn("slow"),s.find(".admin-error").remove(),"undefined"!==n.attr("id")&&""!==n.attr("id")?a.trashAsset({asset_ids:n.attr("id"),dataCallback:function(e){e.error&&s.append("<p class='admin-error'>There was an error removing this exception. Please try again.</p>"),n.fadeOut("slow").remove(),s.find(".ajax-loader").fadeOut("slow")}}):(n.fadeOut("slow").remove(),s.find(".ajax-loader").fadeOut("slow"))}),o.datepicker({dateFormat:"dd-mm-yy",beforeShowDay:function(a){var t,s,n=e(this).parents("li").data("library-day"),r=["Monday","Tuesday","Wednesday","Thursday","Friday","Saturday","Sunday"],i=[[1],[2],[3],[4],[5],[6],[0]],d=[],l=a.getDay();for(t=0;t<r.length;t+=1)r[t]!==n&&d.push(i[t]);for(s=0;s<d.length;s+=1)if(l===d[s][0])return[!1];return[!0]}}),e("#notice-text .action-button").click(function(){var t,s;t=e("#notice-text textarea"),(s=e("#notice-text .action-button")).hide(),t.after('<img class="ajax-loader-notice" src="https://s1.city.ac.uk/i/skin/ajax-loader-small-red.gif">'),a.setMetadataAllFields({asset_id:p,field_info:{126957:t.val()},dataCallback:function(){e("#notice-text .ajax-loader-notice").remove(),s.show()}})})}}}(jQuery);libraryAdmin.init();