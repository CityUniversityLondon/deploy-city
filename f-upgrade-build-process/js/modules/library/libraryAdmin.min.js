var libraryAdmin=function(e){"use strict";var t,a,o=[],n=[],d=e(".modal"),i=e(".modal--delete"),r=e(".modal__box"),s=e(".modal__box--delete"),l=e(".modal__close"),_=e(".modal__close--delete"),c=e(".admin-calendar"),u=c.attr("data-library-id"),p=c.attr("data-calendar-date")||c.attr("data-today-date"),v=p.split("-")[0],y=p.split("-")[1],m={"Every weekday":"DWD","Every weekend day":"DWE","Every day":"DED","Every week":"WEW"},f=e("#event-template"),h=e(".calendarNavLink"),b=new Squiz_Matrix_API({key:"13123496783452586456"}),x=function(){var e=document.location;-1===e.pathname.search(/\_nocache/)?document.location=e.origin+e.pathname+"/_nocache"+e.search:document.location.reload(!0)},E=function(){"closed"===e("#modal__box__special").val()||"open24hours"===e("#modal__box__special").val()?e("#modal__box__times select").prop("disabled",!0):e("#modal__box__times select").prop("disabled",!1)},D=function(a,o){void 0===a?M(o,!1,null):"new modification"===a?M(o,!0,t):A(a),d.addClass("active"),e("[data-id='"+t+"']").removeClass("hover"),e("[data-id='"+t+"']").attr("aria-selected",!0)},k=function(){d.removeClass("active"),e("[data-id='"+t+"']").removeAttr("aria-selected")},g=function(t){e(".modal__box__delete-confirm").prop("disabled",!0);var a,o=new XMLHttpRequest,d="//www.city.ac.uk/api/library-opening-times/delete-event-children?root="+t;o.open("GET",d,!0),o.onreadystatechange=function(){4===this.readyState&&(this.status>=200&&this.status<400?(a=JSON.parse(this.responseText),Object.keys(a.children).length>0&&S(a),setTimeout(function(){e(".modal__box__delete-confirm").prop("disabled",!1)},500),n.push(t)):{error:!0})},o.send(),o=null,i.addClass("active")},T=function(){i.removeClass("active")},C=function(){var t,a,o;t=e("#modal__box__start-day").val(),a=e("#modal__box__end-day").val(),o=e("#modal__box__start-day option").length,parseInt(a,10)<parseInt(t,10)&&e("#modal__box__end-day option").filter(function(){return e(this).text()==t}).prop("selected",!0),e("#modal__box__end-day option").prop("disabled",!1);for(var n=1;n<=o;n++)n<parseInt(t,10)&&e("#modal__box__end-day option:nth-child("+n+")").prop("disabled",!0)},w=function(){var t,a,o;t=e("#modal__box__start-hour").val(),a=e("#modal__box__end-hour").val(),o=e("#modal__box__start-hour option").length,parseInt(a,10)<parseInt(t,10)&&0!=parseInt(a,10)&&e("#modal__box__end-hour option").filter(function(){return e(this).text()==t}).prop("selected",!0),e("#modal__box__end-hour option").prop("disabled",!1);for(var n=2;n<=o;n++)n<=parseInt(t,10)&&e("#modal__box__end-hour option:nth-child("+n+")").prop("disabled",!0)},A=function(e){I(e)},M=function(e,t,a){var o={startDay:e,endDay:"",startHour:"",startMonth:y,startYear:v,startMinute:"",duration:"",endDay:"",endHour:"",endMinute:"",frequency:"",frequencyIcal:"",label:"",modification:t,specialTime:"",weekdays:!1,weekends:!1,legendText:"You are creating a new Event.",eventType:"new",deleteButton:!1,eventTypeToCreate:!0===t?"calendar_event_modification":"calendar_event_recurring",parentModificationId:!0===t?a:""},n=H(f.html(),o,o.parentModificationId);O(n)},I=function(e){var t;t="",t+=H(f.html(),libraryData[e],e),O(t)},H=function(e,t,a){for(var o="",n="",d="",i="",r="",s="",l="",_="",c="",u="",v="",y="",m="",f=t.modification,h=["01","02","03","04","05","06","07","08","09","10","11","12","13","14","15","16","17","18","19","20","21","22","23","24","25","26","27","28","29","30","31"],b=["00","01","02","03","04","05","06","07","08","09","10","11","12","13","14","15","16","17","18","19","20","21","22","23"],x=["00","01","02","03","04","05","06","07","08","09","10","11","12","13","14","15","16","17","18","19","20","21","22","23","24","25","26","27","28","29","30","31","32","33","34","35","36","37","38","39","40","41","42","43","44","45","46","47","48","49","50","51","52","53","54","55","56","57","58","59"],E={"":"None",closed:"Closed",open24hours:"Open 24 Hours"},D={"":"None","bank-holiday":"Bank Holiday","christmas-holiday":"Christmas Holiday","easter-holiday":"Easter Holiday","exam-period":"Exam Period"},k={"Every day":"Every Day","Every week":"Once a Week","Every weekday":"Every Weekday","Every weekend day":"Every Weekend"},g=q(t.startYear,t.startMonth),T=["January","February","March","April","May","June","July","August","September","October","November","December"][parseInt(p.split("-")[1])-1],C=p.split("-")[0],w=0;w<g;w++)h[w]===t.startDay?o+="<option selected>"+h[w]+"</option>":o+="<option>"+h[w]+"</option>",h[w]===t.endDay?i+="<option selected>"+h[w]+"</option>":i+="<option>"+h[w]+"</option>";for(w=0;w<b.length;w++)b[w]===t.startHour?n+="<option selected>"+b[w]+"</option>":n+="<option>"+b[w]+"</option>",b[w]===t.endHour?r+="<option selected>"+b[w]+"</option>":r+="<option>"+b[w]+"</option>";for(w=0;w<x.length;w++)x[w]===t.startMinute?d+="<option selected>"+x[w]+"</option>":d+="<option>"+x[w]+"</option>",x[w]===t.endMinute?s+="<option selected>"+x[w]+"</option>":s+="<option>"+x[w]+"</option>";for(var A in E)E.hasOwnProperty(A)&&(A===t.specialTime?l+='<option value="'+A+'" selected>'+E[A]+"</option>":l+='<option value="'+A+'">'+E[A]+"</option>");for(var A in D)D.hasOwnProperty(A)&&(A===t.label?_+='<option value="'+A+'" selected>'+D[A]+"</option>":_+='<option value="'+A+'">'+D[A]+"</option>");if(f)u="You are editing an exception.",v="exception",c+='<option value="never" selected>never</option>';else{for(var A in k)k.hasOwnProperty(A)&&(A===t.frequency?c+='<option value="'+A+'" selected>'+k[A]+"</option>":c+='<option value="'+A+'">'+k[A]+"</option>");u=t.legendText||"You are editing an existing event.",v=t.eventType||"existing",e=N(e,i,"@@END_DAY@@")}return t.deleteButton&&(y='<button class="modal__box__delete"><i class="fa  fa-times"></i>Delete Event</button>'),m=""===a?"":a,e=N(e,t.eventTypeToCreate,"@@ASSET_TYPE@@"),e=N(e,v,"@@EVENTTYPE@@"),e=N(e,u,"@@LEGEND@@"),e=N(e,o,"@@START_DAY@@"),e=N(e,T+" "+C,"@@MONTH_YEAR@@"),e=N(e,C,"@@YEAR@@"),e=N(e,T,"@@MONTH@@"),e=N(e,n,"@@START_HOUR@@"),e=N(e,d,"@@START_MINUTE@@"),e=N(e,r,"@@END_HOUR@@"),e=N(e,s,"@@END_MINUTE@@"),e=N(e,c,"@@RECURRENCE@@"),e=N(e,y,"@@DELETE_BUTTON@@"),e=N(e,m,"@@EVENT_ID@@"),e=N(e,l,"@@SPECIAL@@"),e=N(e,_,"@@LABEL@@")},N=function(e,t,a){var o=new RegExp(a,"g");return e.replace(o,t)},O=function(e){r.html(e),C(),document.getElementById("modal__box__start-day").addEventListener("change",function(){C()}),w(),document.getElementById("modal__box__start-hour").addEventListener("change",function(){w()}),E(),document.getElementById("modal__box__special").addEventListener("change",function(){E()})},q=function(e,t){for(var a=new Date(e,t-1,1),o=[];a.getMonth()===t-1;)o.push(a.getDate()),a.setDate(a.getDate()+1);return o.length},L=function(){var t,a,o={assetid:e(".modal__box__event-id").val(),startDay:e(".modal__box__start-day").val(),endDay:e(".modal__box__end-day").val(),startHours:e(".modal__box__start-hour").val(),startMinutes:e(".modal__box__start-minute").val(),endHours:e(".modal__box__end-hour").val(),endMinutes:e(".modal__box__end-minute").val(),specialOpen:e(".modal__box__special").val(),specialPeriod:e(".modal__box__label").val(),frequency:e(".modal__box__recurrence").val(),assetType:e(".modal__box__event-asset-type").val()};"undefined"===o.assetType?R(o,void 0):(t=e(".modal__box__year").val()+" "+e(".modal__box__month").val()+" "+o.startDay,o.endDay!==o.startDay&&(t+=" - "+o.endDay,"Every week"===o.frequency?t+=" (weekly)":"Every weekday"===o.frequency?t+=" (weekdays)":"Every weekend"===o.frequency&&(t+=" (weekends)")),a="frequency="+m[o.frequency],a+="&stop_date="+v+"-"+y+"-"+o.endDay,a+="&start_date="+v+"-"+y+"-"+o.startDay,b.createAsset({parent_id:"calendar_event_recurring"===o.assetType?parseInt(u):parseInt(o.assetid),type_code:o.assetType,asset_name:t,link_type:1,link_value:"",sort_order:1,is_dependant:0,is_exclusive:0,extra_attributes:1,attributes:a,dataCallback:function(e){R(o,e.id)}}))},R=function(e,t){var a=t||e.assetid;b.setMultipleAttributes({asset_id:a,field_info:{start_date:v+"-"+y+"-"+e.startDay,stop_date:v+"-"+y+"-"+e.endDay,frequency:m[e.frequency]},dataCallback:function(){b.setMetadataAllFields({asset_id:a,field_info:{287178:v+"-"+y+"-"+e.startDay+" "+e.startHours+":"+e.startMinutes+":00",287179:v+"-"+y+"-"+(null===e.endDay?e.startDay:e.endDay)+" "+e.endHours+":"+e.endMinutes+":00",288411:e.specialOpen,288145:e.specialPeriod,290106:null===e.endDay||e.startDay===e.endDay},dataCallback:function(e){b.setAssetStatus({asset_id:a,status:16,cascade:0,dataCallback:function(){x()}})}})}})},S=function(t){for(var a,o=e(".modal__box--delete__exceptions__list"),d=1;d<=Object.keys(t.children).length;d++)a=t.children[d],o.append('<li data-id="'+a.id+'">'+a.startDay+" "+a.times+"</li>"),n.push(a.id);e(".modal__box--delete__exceptions").css("display","block")},Y=function(e){b.setAssetStatus({asset_id:e,status:2,cascade:1,dataCallback:function(){b.trashAsset({asset_ids:[e],dataCallback:function(){x()}})}})};return{init:function(){var n,p,v,y,m,f;c.find(".eventDate").find(".dateLink").remove(),h.each(function(){e(this).attr("href",e(this).attr("href")+"&root="+u)}),(a=c.find(".eventDate")).each(function(){n=e(this),p=n.find("[data-id]"),t=p.attr("data-id"),y=p.attr("data-date"),m=p.attr("data-special"),f=p.attr("data-label"),e.inArray(t,o)<0&&o.push(t),n.attr({"data-id":t,"data-date":y,"data-special":m,"data-label":f}),v=o.length;for(var a=0;a<v;a++)e("[data-id='"+o[a]+"']").parents(".eventDate").addClass("event--"+(a+1));p.removeAttr("data-id data-date data-special data-label")}),e(".calendar").removeClass("calendar--loading"),a.hover(function(){t=e(this).attr("data-id"),e("[data-id='"+t+"']").addClass("hover")},function(){e("[data-id='"+t+"']").removeClass("hover")}),e(".unused").hover(function(){e(this).addClass("hover")},function(){e(this).removeClass("hover")}),c.find(".date").click(function(a){var o=e(this),n="";if(!e(a.target).hasClass("event__add-exception"))return o[0].hasAttribute("data-id")?(t=e(this).attr("data-id"),void D(t,void 0)):(n=o.find(".dateLink").html(),void D(void 0,parseInt(n)<10?"0"+n:n));D("new modification",o.attr("data-date").split(" ")[0])}),_.click(function(){T()}),l.click(function(){k()}),e(document).keyup(function(e){27===e.keyCode&&(i.hasClass("active")?T():d.hasClass("active")&&k())}),r.on("click",function(a){var o=e(a.target);a.preventDefault(),o.hasClass("modal__box__submit")&&(r.addClass("modal__box--loading"),r.off("click"),L()),o.hasClass("modal__box__delete")&&(r.off("click"),g(t))}),s.on("click",function(a){e(a.target).hasClass("modal__box__delete-confirm")&&(a.preventDefault(),Y(t))})}}}(jQuery);libraryAdmin.init();