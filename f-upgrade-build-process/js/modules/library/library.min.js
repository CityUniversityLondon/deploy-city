CITY.library=function(e){"use strict";var t=e(".library-search"),a=t.find(".dropdown-select"),n=a.find(".display").find("span"),i=t.find(".search-refine-wrapper input"),s=e("[data-library-id]").length,r=e(".opening-times-navigation .calendarNavLink"),d=e(".opening-times-panel--left > h3"),o=["monday","tuesday","wednesday","thursday","friday","saturday","sunday"],l=function(t){var a=e(t.target).prop("selectedIndex");i.prop("checked",!1),i.eq(a).prop("checked",!0)},p=function(t){var s,r,d=e(t.target);t.preventDefault(),a.toggleClass("active"),d.hasClass("option")&&(d.attr("data-value"),r=d.index(),s=d.html(),i.prop("checked",!1),i.eq(r).prop("checked",!0),n.html(s),a.removeClass("active"))},m=function(e,t){return new Date(e.getTime()+24*t*60*60*1e3)},c=function(e){var t=e.getDate(),a=e.getMonth()+1;return t<10&&(t="0"+t),a<10&&(a="0"+a),e.getFullYear()+"-"+a+"-"+t},u=function(e){return{0:"Jan",1:"Feb",2:"Mar",3:"Apr",4:"May",5:"Jun",6:"Jul",7:"Aug",8:"Sep",9:"Oct",10:"Nov",11:"Dec"}[e.getMonth()]},y=function(e){return e.charAt(0).toUpperCase()+e.slice(1)},h=function(e){var t,a=new XMLHttpRequest,n="//www.city.ac.uk/api/library-opening-times/current-week/_nocache?SQ_CALENDAR_VIEW=week&SQ_CALENDAR_DATE="+(e.week||"");a.open("GET",n,!0),a.onreadystatechange=function(){4===this.readyState&&(this.status>=200&&this.status<400?(t=JSON.parse(this.responseText),g({data:t,todayClean:t.todayClean,todayDay:t.todayDay,queryWeek:t.queryWeek,updateElements:e.updateElements})):{error:!0})},a.send(),a=null,e.updateElements.addClass("opening-times-busy")},g=function(t){var a,n,i,s,r,d,l=e("[data-times-type=daily]"),p=e("[data-times-type=weekly]"),h=e("[data-times-type=call-to-action]"),g="",f="",v=t.updateElements;l.length>0?v.each(function(){var a=e(this),o=a.attr("data-library-id"),l=t.data.libraries[o].times[t.todayDay];i=l.special,s=l.date,r=l.startTime,d=l.endTime,e(".opening-times--home-controls h2 a time").html(t.todayClean),n=a.find(".opening-times--home-list-item-times"),g="closed"===i?"<span><em>Closed</em></span>":"open24hours"===i?"<span><em>Open 24 hours</em></span>":'<time datetime="'+s+"T"+r.replace(".",":")+'">'+r+'</time><span> &ndash; </span><time datetime="'+s+"T"+d.replace(".",":")+'">'+d+"</time>",n.html(g),a.removeClass("opening-times-busy")}):p.length>0?function(t,a){a.each(function(){for(var a,n,i,s,r,d,l,p,h,g,f,v,b,C,k=e(this),D=k.attr("data-library-id"),T=t.data.libraries[D],E=(T.times,k.find(".opening-times-list-card .opening-times-panel--left .opening-times-table tbody")),A="",w="",_=0;_<o.length;_++)T.times[o[_]]?(n=(a=T.times[o[_]]).special,i=a.date,s=a.dateClean.split(",",1),r=a.startTime,d=a.endTime,A+=a.isToday?'<tr data-date="'+s+'" class="is-today">':'<tr data-date="'+s+'">',A+="<td><span>"+y(o[_])+"</span></td>",A+="<td>",A+="closed"===n?"<span><em>Closed</em></span>":"open24hours"===n?"<span><em>Open 24 hours</em></span>":'<time datetime="'+i+"T"+r.replace(".",":")+'">'+r+'</time><span> &ndash; </span><time datetime="'+i+"T"+d.replace(".",":")+'">'+d+"</time>",A+="</td>",A+="</tr>"):(A+="<tr>",A+="<td><span>"+y(o[_])+"</span></td>",A+="<td><span>No time availalble</span></td>",A+="</tr>");""!==t.queryWeek?(l=t.queryWeek.split("-"),p=new Date(l[0],l[1]-1,l[2]),h=m(p,6),g=p.getDate()+" "+u(p)+" until "+h.getDate()+" "+u(h),f=m(p,7),v=c(f),b=m(p,-7),C=c(b),k.find(".opening-times-navigation-previous a").attr("href","?SQ_CALENDAR_VIEW=week&SQ_CALENDAR_DATE="+C),k.find(".opening-times-navigation-next a").attr("href","?SQ_CALENDAR_VIEW=week&SQ_CALENDAR_DATE="+v),w=g):w=t.data.currentWeekRange,k.find(".opening-times-navigation-date-range time").text(w).attr("data-toggle","on"),E.html(A),k.removeClass("opening-times-busy")})}(t,v):h.length>0&&v.each(function(){var o,l=e(this),p=l.find(".library-aside-call-to-action-subtitle");a=l.attr("data-library-id"),o=t.data.libraries[a].times[t.todayDay],i=o.special,s=o.date,r=o.startTime,d=o.endTime,n=l.find(".library-aside-call-to-action-title"),"closed"===i?g="Closed":(g="Open",f="open24hours"===i?"24 hours":'until <time datetime="'+s+"T"+d.replace(".",":")+'">'+d+"</time>"),g+=" Today",n.html(g),p.html(f),l.removeClass("opening-times-busy")})};return{init:function(){d.remove(),a.on("click",p),e(".library-search__content-type").change(l),0!==s&&(h({week:"",updateElements:e("[data-times-type]")}),r.on("click",function(t){var a=e(this),n=a.attr("href").split("=")[2],i=a.parents("[data-times-type]");i.hasClass("opening-times-busy")||h({week:n,updateElements:i}),t.preventDefault()}))}}}($),CITY.library.init();