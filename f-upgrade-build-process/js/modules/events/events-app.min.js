CITY.events=function(e){var t=function(t,n){var s=t.Model.extend({}),i=!!$(".events-home").length,l=Backbone.Collection.extend({model:s,url:function(){var t="/fb/search.json?collection=city-events&meta_P_orsand=%22Yes%22&landing=true&sort=adate&_=1373022367687",a=$("div.event-calendar-wrap").data("department"),n=$("div.event-calendar-wrap").data("category");if(null!=a&&(t+="&meta_F_orsand=%22"+a+"%22"),null!=n&&(t+="&meta_y_orsand=%22"+n+"%22"),e.location.search){var s=e.location.search.match(/[\?&](meta_E_orsand=[^&]+)(&|$)/);s&&(t+="&"+s[1]),console.log(t)}return t},parse:function(e){var t=[];return e.response&&e.response.resultPacket?(_.each(e.response.resultPacket.results,function(e){var a={};_.each(e,function(e,t){if(_.isObject(e))_.each(e,function(e,t){a[t]=e});else if(_.isArray(e)){if(!e.length)return;a[t]=e}else a[t]=e}),t.push(a)}),t):t}}),o=function(e,t){return 32-new Date(t,e,32).getDate()},r=function(e){if(this.months=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],this.dday="",this.dmonth="",this.dyear="",!(!e instanceof Date))return this.dday=e.getDate().toString(10),this.dmonth=this.months[e.getMonth()],this.dyear=e.getFullYear().toString(10),1===this.dday.length&&(this.dday="0"+this.dday),{dday:this.dday,dmonth:this.dmonth,dyear:this.dyear,dateString:this.dday+"-"+this.dmonth+"-"+this.dyear}},c=['<ul class="clearfix filter-list">','<li><a class="calendar-link filter" id="reset" href="/<%= attrs.pathname %>/calendar#reset/reset" data-param=\'reset\' data-href="reset">All upcoming events</a></li>','<li><a class="calendar-link filter" href="/<%= attrs.pathname %>/calendar#show/equalTo/<%= attrs.fbToday.dateString %>" data-param=\'show/equalTo\' href=\'\' data-href="<%= attrs.fbToday.dateString %>">Today</a></li>','<li><a class="calendar-link filter" href="/<%= attrs.pathname %>/calendar#show/max/<%= attrs.weekEnd.dateString %>" data-param=\'show/max\' href=\'\' data-href="<%= attrs.weekEnd.dateString %>">This week</a></li>','<li><a class="calendar-link filter" href="/<%= attrs.pathname %>/calendar#show/max/<%= attrs.fbEndOfMonth.dateString %>" data-param=\'show/max\' href=\'\' data-href="<%= attrs.fbEndOfMonth.dateString %>">This month</a></li>',"</ul>"].join("\n"),d=n.ItemView.extend({el:$("#calendar-links"),initialize:function(){_.bindAll(this,"render"),this.render()},template:function(){var t;return this.noOfDaysFromNow=new Date,this.today=new Date,this.endOfMonthObj=new Date(this.today.getFullYear(),this.today.getMonth(),o(this.today.getMonth(),this.today.getFullYear())),this.fbEndOfMonth=r(this.endOfMonthObj),this.fbToday=r(this.today),this.weekEnd=r((t=this.today,new Date(t.getFullYear(),t.getMonth(),t.getDate()+6-t.getDay()))),this.pathname=e.location.pathname.split("/")[1],_.template(c,this,{variable:"attrs"})}}),h=Backbone.View.extend({el:$("#calendar"),initialize:function(){_.bindAll(this,"render"),this.render()},render:function(){$(this.el).append(this.calendarBuild(this.$el))},calendarBuild:function(t){var a=this,n=0;for(this.calendar=t,this.fbUrl="/fb/search.json?collection=city-events&sort=adate&meta_P_orsand=%22Yes%22&form=calendar&date=all&landing=true",this.noOfDaysFromNow=new Date,this.today=new Date,this.endOfMonthObj=new Date(this.today.getFullYear(),this.today.getMonth(),o(this.today.getMonth(),this.today.getFullYear())),this.fbEndOfMonth=r(this.endOfMonthObj),this.fbToday=r(this.today),this.noOfDaysFromNow.setDate(this.noOfDaysFromNow.getDate()+365),this.results=this.collection.models,this.resultsLength=this.results.length,this.eventDates=[];n<this.resultsLength;n++)this.results[n].attributes.d&&this.eventDates.push($.datepicker.parseDate("yy-mm-dd",this.results[n].attributes.d).setHours(0,0,0,0));this.calendar.datepicker({onSelect:function(t,a){if(i){var n="/calendar#show/equalTo/"+a.currentDay+"-"+["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"][a.currentMonth]+"-"+a.currentYear;e.location.href+=n}},maxDate:this.noOfDaysFromNow,minDate:0,beforeShowDay:function(e){return-1!==$.inArray(e.setHours(0,0,0,0),a.eventDates)?[!0,"selectable"]:[!1]}}),t.removeClass("component-loading").children(".loading-fa-icon").remove()}}),f=e.EventsAPP;f.collections.calendarCollection=new l,f.collections.calendarCollection.fetch({success:function(){f.views.linksView=new d({collection:f.collections.calendarCollection}),f.views.calendarView=new h({collection:f.collections.calendarCollection})}}),$(".event-calendar-wrap").length&&a(Backbone,Backbone.Marionette)},a=function(t,a){function n(e){CITY.debug(e)}var s=t.Model.extend({}),i={$body:$("html, body"),$filters:$(".filters"),$summary:$("#fb-summary")},l=function(){i.$body.hasClass("screen-thin")&&i.$body.animate({scrollTop:i.$summary.offset().top},400)},o=Backbone.Paginator.clientPager.extend({model:s,initialize:function(){this.on("all",function(e){n("events collection event fired: "+e)})},paginator_core:{dataType:"json",url:"/fb/search.json"},paginator_ui:{perPage:100},server_api:{collection:"city-events",landing:"true",sort:"adate",meta_P_orsand:"Yes",meta_F_orsand:function(){if(null!=$("div.event-calendar-wrap").data("department"))return"%22"+$("div.event-calendar-wrap").data("department")+"%22"},meta_y_orsand:function(){if(null!=$("div.event-calendar-wrap").data("category"))return"%22"+$("div.event-calendar-wrap").data("category")+"%22"}},parse:function(e){var t=[];return e.response&&e.response.resultPacket?(_.each(e.response.resultPacket.results,function(e){var a={};_.each(e,function(e,t){if(_.isObject(e))_.each(e,function(e,t){a[t]=e});else if(_.isArray(e)){if(!e.length)return;a[t]=e}else a[t]=e}),t.push(a)}),t):t},searchFunnelback:function(e){var t=decodeURIComponent($.param(_.extend(this.server_api,{query:e}))),a=this;this.fetch({success:function(){a.sortedAndFilteredModels=a.models.slice(),a.info()},data:t})}}),r=['<div class="event-top cf">','<div class="date">','<p class="date-month"><% var eventMonth = data.H.substring(0, 3); %><%= eventMonth %></p>','<p class="date-day-no"><%= data.G %></p>','<p class="date-day"><%= data.K %></p>',"</div>",'<div class="event-details">','<h2 itemprop="name" class="event-title"><a href="',"<% if (data.Y) { %>","<%= data.Y %>","<% } else { %>","<%= data.liveUrl %>",'<% } %>"','class="summary url" itemprop="url"><%= data.title %></a></h2>','<time itemprop="startDate" datetime="<%= data.B %>z" class="event-time"><i class="fa fa-clock-o"></i>',"<% if (data.Q) { %>","<%= data.Q %><%= data.U %>","<% } else { %>","<%= data.J %>","<% } %>","</time>","<% if (data.y) { %>",'<p class="event-category"><i class="fa fa-tag"></i> <%= data.y %></p>',"<% } %>","<% if (data.M) { %>",'<p class="event-audience"><i class="fa fa-users"></i> <%= data.M %></p>',"<% } %>","</div>","</div>",'<p class="event-summary" itemprop="description"><%= data.c %></p>'].join("\n"),c=a.ItemView.extend({tagName:"li",className:"event vevent",attributes:{itemtype:"http://schema.org/Event",itemscope:""},template:function(e){return _.template(r,e,{variable:"data"})}}),d=a.CollectionView.extend({el:"#events-results",itemView:c,firstRender:!0,initialize:function(){this.$el.empty(),this.$el.addClass("backbone-ready"),this.$el.show(),this.on("render",this.removeSpinners)},removeSpinners:function(){this.$el.removeClass("component-loading").children(".loading-fa-icon").remove()}}),h=t.View.extend({el:"#calendar-links",events:{"click li a":"filterClick"},filterClick:function(e){var t=$(e.target),a=t.data("param")+"/"+t.data("href"),n=t.hasClass("selected");e.preventDefault(),i.$filters.find("a").removeClass("selected"),"reset"===t.data("href")||n?a="clear":t.addClass("selected"),m.router.navigate(a,{trigger:!0}),l()}}),f=t.View.extend({el:"#categories",events:{"click li a":"filterClick"},filterClick:function(e){var t=$(e.target),a=t.attr("href"),n=t.hasClass("selected");e.preventDefault(),$(".filters").find("a").removeClass("selected"),"reset"===t.data("href")||n?a="clear":t.addClass("selected"),m.router.navigate(a,{trigger:!0}),l()}}),u=t.View.extend({el:"#calendar",events:{"mousedown td a":"facetClick"},facetClick:function(e){var t=$(e.target),a="show/equalTo/"+encodeURIComponent(t.text())+"-"+["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"][encodeURIComponent(t.parent().data("month"))]+"-"+t.parent().data("year");e.preventDefault(),m.router.navigate(a,{trigger:!0}),l()}}),v=a.ItemView.extend({el:".results-summary",collectionEvents:{sync:"render",reset:"render",sort:"render"},template:function(e){return e.info=m.collections.eventsCollection.information,_.template("<span class='results-totals'><%= info.startRecord %> - <%= info.endRecord %> of <%= info.totalRecords %> results</span>",e)}}),p=t.Router.extend({routes:{clear:"defaultRoute","show/:param/:value":"showRoute","search/:param/:value":"searchRoute"},initialize:function(){m.collections.eventsCollection.once("sync",function(){n("starting router"),$(function(){t.history.start({root:e.location.pathname})})}),m.collections.eventsCollection.fetch({success:function(){m.collections.eventsCollection.pager()},silent:!0})},defaultRoute:function(){$(".no-results").remove(),$(".filters").find("a").removeClass("selected"),$("#reset").addClass("selected"),m.collections.eventsCollection.setFieldFilter()},searchRoute:function(e,t){$(".no-results").remove(),t=t.replace("+"," ").match(/[\w ]/g).join(""),m.collections.eventsCollection.setFieldFilter([{field:e,type:"equalTo",value:t}]),m.collections.eventsCollection.length||$("#events-results").append('<li class="no-results"><h2>No upcoming events of this type</h2><p class="cta soft-cta"><a class="reset" href="#clear">Reset filters</a></p></li>'),$.each($("#category-select").find("a"),function(e,a){$(a).data("href").replace("+"," ").match(/[\w ]/g).join("")===t&&$(a).addClass("selected")})},showRoute:function(e,t){var a=t.split("-");$(".no-results").remove(),m.collections.eventsCollection.setFieldFilter([{field:"G",type:e,value:a[0]},{field:"H",type:"pattern",value:a[1]},{field:"I",type:e,value:a[2]}]),i.$filters.find("a").removeClass("selected"),$.each($("#calendar-links").find("a"),function(a,n){$(n).data("href")!==t&&$(n).data("param")!==e||$(n).addClass("selected")}),m.collections.eventsCollection.length||$("#events-results").append('<li class="no-results"><h2>No events for this period are availiable to show</h2><p class="cta soft-cta"><a class="reset" href="#clear">Reset filters</a></p></li>')}}),m=e.EventsAPP;m.collections.eventsCollection=new o,m.views.searchMetaView=new v({collection:m.collections.eventsCollection}),m.views.eventsListView=new d({collection:m.collections.eventsCollection}),m.views.facetsView=new u({collection:m.collections.eventsCollection}),m.views.linksActionView=new h,m.views.catLinksActionView=new f,m.router=new p};return{init:function(){var a,n,s,i,l,o={collections:{calendarCollection:void 0,eventsCollection:void 0},views:{linksView:void 0,categoryView:void 0,linksActionView:void 0,calendarView:void 0,eventsListView:void 0,facetsView:void 0},router:void 0};e.EventsAPP=o,$("#calendar").length&&t(Backbone,Backbone.Marionette),$(".single-event").length&&(a=$("#booking-form"),n=$(".event-book"),s=function(){a.addClass("show"),$("html, body").animate({scrollTop:a.offset().top},500)},n.on("click",function(e){e.preventDefault(),s()}),(a.find(".wFormThankYou").length||a.find(".errorMessage").length)&&s(),i=$("#related-events"),l=i.find("ul"),i&&l.bxSlider({slideWidth:320,minSlides:1,maxSlides:3,slideMargin:30,moveSlides:1,infiniteLoop:!1,nextText:'<i class="fa fa-caret-right"></i>',prevText:'<i class="fa fa-caret-left"></i>',touchEnabled:!0,preventDefaultSwipeY:!0,adaptiveHeight:!1,pager:!1,hideControlOnEnd:!0,responsive:!0})),$(".events-home").length&&$("#primary-nav-toggler").addClass("events-home-title")}}}(window),CITY.events.init();