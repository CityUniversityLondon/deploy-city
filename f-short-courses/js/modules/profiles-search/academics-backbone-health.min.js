!function(e,t){function i(e){CITY.debug(e)}var a={collections:{academicsCollection:void 0},views:{academicsListView:void 0,facetsView:void 0},router:void 0},l=e.Model.extend({}),n=function(){for(var e=0;e<a.collections.academicsCollection.length;e++)e%2===0&&$("li.academic:eq("+e+")").addClass("odd")},s=Backbone.Paginator.clientPager.extend({model:l,initialize:function(){this.on("all",function(e){i("academics collection event fired: "+e)})},paginator_core:{dataType:"json",url:"/fb/search.json"},paginator_ui:{perPage:20},server_api:{collection:"academics-matrix",landing:"true",sort:"metaR"},parse:function(e){var t=[];return e.response&&e.response.resultPacket?(_.each(e.response.resultPacket.results,function(e){var i={};_.each(e,function(e,t){if(_.isObject(e))_.each(e,function(e,t){i[t]=e});else if(_.isArray(e)){if(!e.length)return;i[t]=e}else i[t]=e}),t.push(i)}),t):t},searchFunnelback:function(e){var t,i=this.server_api,a=this;delete i.sort,t=decodeURIComponent($.param(_.extend(i,{query:e}))),this.fetch({success:function(){a.sortedAndFilteredModels=a.models.slice(),a.info()},data:t})}}),c=['<div class="image">','<a href="<%= attrs.liveUrl %>">',"<% if (attrs.O) { %>",'<img class="thumbnail" src="<%= attrs.O %>">',"<% } else { %>",'<i class="fa fa-user" />',"<% } %>","</a>","</div><!-- /.image -->",'<div class="who">','<h2><a href="<%= attrs.liveUrl %>"><%= attrs.title %></a></h2>',"<p class=\"job-title\"><% if ((attrs.P).length > 50) { print(attrs.P.substring(0, 50) + '...') } else { print(attrs.P); } %></p>","</div>",'<div class="meta">',"<% if (attrs.E || attrs.F) { %>",'<p class="business-unit"><i class="fa fa-building-o"></i>',"",'<% if (attrs.F) { _.each(attrs.F.split(","), function (dept) { dept = $.trim(dept); %>',"<% if (!dept) return; %>",'<a class="filter department" href="#" data-filter-param="F" data-filter-value="<%= dept %>" ','title="Find other staff in <%= dept %>"><%= dept %></a>',"<% }); } %>","</p><!--.business-unit-->","<% } %>","</div><!-- /.meta -->"].join("\n"),r=t.ItemView.extend({tagName:"li",className:"academic",template:function(e){return _.template(c,e,{variable:"attrs"})},events:{"click .filter":"filterClick"},filterClick:function(e){var t=$(e.target).data();i(e.target.className+" clicked"),a.router.navigate("search/"+t.filterParam+"/"+encodeURIComponent(t.filterValue).replace(/%20/g,"+"),{trigger:!0}),e.preventDefault()}}),o=t.CollectionView.extend({el:"#academic-results",itemView:r,firstRender:!0,initialize:function(){this.$el.addClass("loading"),this.$el.empty(),this.$el.addClass("backbone-ready"),this.on("render",this.removeSpinners)},removeSpinners:function(){this.firstRender&&($(".initial-loading-indicator").remove(),this.firstRender=!1),this.$el.removeClass("loading")}}),d=e.View.extend({el:".filters",facetsFound:null,initialize:function(){var e=this;e.listenTo(e.collection,"reset",e.updateSelected),$(function(){e.$filters=e.$el.find(".filter"),e.facetsFound=e.findFacets()})},updateSelected:function(){var e,t;this.$filters.removeClass("selected"),this.collection.fieldFilterRules&&this.collection.fieldFilterRules.length&&(e=this.collection.fieldFilterRules[0].field,t=this.collection.fieldFilterRules[0].value.source,this.$filters.filter("[data-filter-param='"+e+"']").filter("[data-filter-value='"+t+"']").addClass("selected"))},events:{"click .filter":"facetClick"},facetClick:function(e){var t=$(e.target),i="search/"+t.data("filter-param")+"/"+encodeURIComponent(t.data("filter-value")).replace(/%20/g,"+");e.preventDefault(),t.hasClass("selected")?(t.removeClass("selected"),i=""):(this.$el.find(".filter").removeClass("selected"),t.addClass("selected")),a.views.searchboxView.empty(),a.router.navigate(i,{trigger:!0})},findFacets:function(){var e=[];return this.$filters.each(function(){e.push($(this).data("filter-param"))}),_.uniq(e)}}),f=e.View.extend({el:"#fb-queryform",events:{"submit form":"doQuery"},initialize:function(){this.$inputEl=this.$el.find("input"),this.inputWidth=this.$inputEl.width(),this.tfView=a.views.tagFilterView},doQuery:function(e){var t=$.trim(this.$inputEl.val());e.preventDefault(),i("search requested for "+t),0!==t.length&&(a.views.tagFilterView.removeFilter(),a.router.navigate("search/query/"+t,{trigger:!0}))},setText:function(e){this.$inputEl.val(e)},empty:function(){this.$inputEl.val("")}}),u=t.ItemView.extend({el:".tag-filters",events:{click:function(){this.removeFilter(!0)}},template:function(e){return $("<span />",{"class":"tag-filter",title:"click to remove this filter",html:"tag: "+e.value+"<i class='fa fa-times'></i>"})},removeFilter:function(e){this.$el.empty(),this.trigger("render"),e&&a.router.navigate("",{trigger:!0})}}),h=t.ItemView.extend({el:".results-summary",collectionEvents:{sync:"render",reset:"render",sort:"render"},onRender:function(){n()},template:function(e){return e.info=a.collections.academicsCollection.information,_.template("<span class='results-totals'><%= info.startRecord %> - <%= info.endRecord %> of <%= info.totalRecords %> results</span>",e)}}),m=t.ItemView.extend({el:".read-more",collectionEvents:{sync:"checkIfNeeded",reset:"checkIfNeeded",sort:"checkIfNeeded"},events:{"click .infinite":"showNextPage"},initialize:function(){this.collection.origPerPage=this.collection.paginator_ui.perPage},template:function(e){return _.template("<a class='infinite' href='#'>Show more</a>",e)},checkIfNeeded:function(){this.collection.information.perPage>this.collection.information.totalRecords?this.$el.hide():this.$el.show()},showNextPage:function(e){e.preventDefault();var t,i=this.collection,a=i.information;a.perPage<a.totalRecords&&(t=a.perPage+i.origPerPage,i.howManyPer(t),t>=a.totalRecords&&this.$el.hide())}}),v=e.Router.extend({routes:{"":"defaultRoute","search/query/:value":"fbSearchRoute","search/:param/:value":"searchRoute"},initialize:function(){a.collections.academicsCollection.once("sync",function(){i("starting router"),$(function(){e.history.start({root:window.location.pathname})})}),a.collections.academicsCollection.fetch({success:function(){a.collections.academicsCollection.pager()},silent:!0})},defaultRoute:function(){a.collections.academicsCollection.setFieldFilter(),a.views.tagFilterView.removeFilter()},searchRoute:function(t,i){i=$.trim(i).replace(/\+/g," ","gi"),a.collections.academicsCollection.setFieldFilter([{field:t,type:"pattern",value:new RegExp(i)}]),_.contains(a.views.facetsView.facetsFound,t)||(a.views.tagFilterView.model=new e.Model({value:i}),a.views.tagFilterView.render()),a.views.searchboxView.empty()},fbSearchRoute:function(e){a.collections.academicsCollection.searchFunnelback($.trim(e).replace(/\+/g," ")),a.views.searchboxView.setText(e),a.views.tagFilterView.removeFilter()}});a.collections.academicsCollection=new s,a.views.academicsListView=new o({collection:a.collections.academicsCollection}),a.views.facetsView=new d({collection:a.collections.academicsCollection}),a.views.tagFilterView=new u,a.views.searchboxView=new f,a.views.searchMetaView=new h({collection:a.collections.academicsCollection}),a.views.paginationControlsView=new m({collection:a.collections.academicsCollection}),a.router=new v,window.SEARCHAPP=a}(Backbone,Backbone.Marionette);