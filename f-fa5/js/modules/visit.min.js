CITY.visit=function(e,i){var t={},n="//www.city.ac.uk/visit/feeds/locations",r=new google.maps.LatLng(51.527761,(-.103283)),o=i("#map-container"),a={zoom:17,center:r,mapTypeId:google.maps.MapTypeId.ROADMAP,streetViewControl:!0,mapTypeControl:!0,mapTypeControlOptions:{style:google.maps.MapTypeControlStyle.DROPDOWN_MENU},navigationControl:!0},s=new google.maps.Map(document.getElementById("map-canvas"),a),l=i("#map-search"),g=new google.maps.InfoWindow({maxWidth:400}),c={bigMarkersArray:[],bigBuildingsArray:[],buildingsObj:{},buildings:{toggler:null,markersArray:[],zoomLevel:17,list:""},libraries:{toggler:i("#toggle-libraries"),markersArray:[],zoomLevel:17,list:""},accommodation:{toggler:null,markersArray:[],zoomLevel:17,list:""},lectureTheatres:{toggler:null,markersArray:[],zoomLevel:17,list:""},studentCentre:{toggler:i("#toggle-studentCentre"),markersArray:[],zoomLevel:17,list:""},sports:{toggler:null,markersArray:[],zoomLevel:17,list:""},computerLabs:{toggler:i("#toggle-computerLabs"),markersArray:[],zoomLevel:17,list:""}},p={cycleHire:{src:"http://webapps.city.ac.uk/matrix/maps/cycle-hire.php",toggler:i("#cycle-hire"),preserveViewport:!0},bikes:{src:"http://webapps.city.ac.uk/matrix/maps/cycle-parking.kml",toggler:i("#bikes"),preserveViewport:!0},atms:{src:"http://webapps.city.ac.uk/matrix/maps/atms.kml",toggler:i("#cash-points"),preserveViewport:!0}},u=function(e){var i;if(e)for(i in e)e.hasOwnProperty(i)&&"function"!=typeof e[i]&&e[i].setMap(null)},d=function(e){var t,n=e.getState();i.each(n,function(e,n){return"0"===e?void g.close():void i.each(c.buildingsObj,function(i,n){e===i&&(t=n,u(c.bigMarkersArray),t.setVisible(!0),g.setContent(t.infoHtml),g.open(s,t),s.panTo(t.position),t.setMap(s))})})},m=function(e){var t={},n="";e&&("string"==typeof e?(n=e,t[n]=1):e.hasOwnProperty("id")?(n=e.id,t[n]=1):t[0]=1,i.bbq.pushState(t,2))},f=function(e){var i;if(e)for(i in e)e.hasOwnProperty(i)&&"function"!=typeof e[i]&&e[i].setMap(s)},h=function(e){this.toggler=null,this.markersArray=[],this.zoomLevel=17},y=function(e){i.each(e,function(){var e=this.toggler,i=new google.maps.KmlLayer(this.src,{preserveViewport:this.preserveViewport});e.click(function(t){return e.toggleClass("enabled"),i.setMap(e.hasClass("enabled")?s:null),!1})})},b=function(e){var t,n,r,o="#"+e.category,a="";return a=0!==e.linkHref.length?'<div id="info-window" style="min-height: 100px;"><h3><a href="'+e.linkHref+'">'+e.name+"</a></h3>":'<div id="info-window" style="min-height: 100px;"><h3>'+e.name+"</h3>",0!==e.buildingPrefix.length&&(a+='<p class="building-prefix"><strong>Rooms beginning: '+e.buildingPrefix+"</strong></p>",e.buildingPrefix="("+e.buildingPrefix+")"),a+=e.description+"</div>",t=new google.maps.Marker({map:e.map,position:e.point,icon:e.icon,animation:google.maps.Animation.DROP}),t.set("id",e.id),t.set("infoHtml",a),google.maps.event.addListener(t,"click",function(e){return m(t)}),n=i("<li />",{id:"building-"+e.id,"class":"building"}),r=i("<a />",{href:"#",html:"<span>"+e.name+" "+e.buildingPrefix+"</span>",click:function(e){return m(i(e.target).parents("li").attr("id").replace("building-","")),!1},css:{background:"transparent url("+e.icon+"?v=1123) no-repeat left center"}}),n.append(r).appendTo(o),t},v=function(e,t){var n="";return e.children().each(function(){return this.nodeName!=t||(n=i(this).text(),!1)}),n},k=function(e,t,n){var r,a,s=0,p={},u=[],y={};i(e).find("item").each(function(){r=i(this),p.index=s+1,p.name=r.find("title").text(),p.linkHref=r.find("link").text(),p.description=r.find("description").text(),p.icon=v(r,"CUL:icon"),p.category=r.find("category").text(),p.id=r.find("guid").text(),p.buildingPrefix=v(r,"CUL:buildingPrefix").replace(/^\s+|\s+$/g,""),p.hexColour=v(r,"CUL:hexColour").replace(/^\s+|\s+$/g,""),p.geoLat=v(r,"geo:lat"),p.geoLong=v(r,"geo:long"),p.point=new google.maps.LatLng(parseFloat(p.geoLat),parseFloat(p.geoLong)),a=b(p),"buildings"!==p.category?c.bigMarkersArray.push(a):c.bigBuildingsArray.push(a),c.buildingsObj[a.id]=a,u.push(p.name),y[p.name]=p.id,c[p.category]?c[p.category].markersArray.push(a):c[p.category]=h(p.category)}),l.autocomplete({source:u,select:function(e){setTimeout(function(){var e=l.val();l.blur(),e in y&&m(y[e])},0)}}).focusin(function(){l.attr("value","")}),i("#vs-button").click(function(){l.focus()}),google.maps.event.addListener(g,"closeclick",function(){m(g)}),f(c.bigBuildingsArray),o.removeClass("loading").children(".loading-fa-icon").remove(),i(window).bind("hashchange",d),i(window).trigger("hashchange")},w=function(){i.ajax({type:"GET",url:n,dataType:"xml",success:k})},x=function(){o.addClass("loading").append(i('<i class="fa fa-refresh fa-spin loading-fa-icon"></i>')),y(p),w(),i("#filter").accordion({collapsible:!0,autoHeight:!1,clearStyle:!0,active:!1}),i("#journey-link").bind("click",function(e){e.preventDefault(),i("html, body").animate({scrollTop:i("#journey-planner").offset().top},1e3)})};return t={init:x,cityLayers:c,infoWindow:g,map:s}}(CITY,jQuery),CITY.visit.init();