CITY.library=function(T){"use strict";var e=T(".library-search"),i=e.find(".dropdown-select"),s=i.find(".display").find("span"),r=e.find(".search-refine-wrapper input"),t=T("[data-library-id]").length,a=T(".opening-times-navigation .calendarNavLink"),n=T(".opening-times-panel--left > h3"),k=["monday","tuesday","wednesday","thursday","friday","saturday","sunday"],o=function(e){var t=T(e.target).prop("selectedIndex");r.prop("checked",!1),r.eq(t).prop("checked",!0)},d=function(e){var t,a,n=T(e.target);e.preventDefault(),i.toggleClass("active"),n.hasClass("option")&&(n.attr("data-value"),a=n.index(),t=n.html(),r.prop("checked",!1),r.eq(a).prop("checked",!0),s.html(t),i.removeClass("active"))},w=function(e,t){var a=t?36e5:-36e5,n=m(e.getFullYear()),i=u(e.getFullYear()),s=[];if(0<t)for(var r=0;r<t;r++){var o=e.getDate()+r+1;s.push(new Date(e.getFullYear(),e.getMonth(),o))}else for(r=0;t<r;r--){o=e.getDate()+r-1;s.push(new Date(e.getFullYear(),e.getMonth(),o))}return l(s,i)||l(s,n)?new Date(e.getTime()+24*t*60*60*1e3+a):new Date(e.getTime()+24*t*60*60*1e3)},l=function(e,t){return!!e.find(function(e){return e.getTime()==t.getTime()})},E=function(e){var t=e.getDate(),a=e.getMonth()+1;return t<10&&(t="0"+t),a<10&&(a="0"+a),e.getFullYear()+"-"+a+"-"+t},A=function(e){return{0:"Jan",1:"Feb",2:"Mar",3:"Apr",4:"May",5:"Jun",6:"Jul",7:"Aug",8:"Sep",9:"Oct",10:"Nov",11:"Dec"}[e.getMonth()]},_=function(e){return e.charAt(0).toUpperCase()+e.slice(1)},p=function(e){var t,a=new XMLHttpRequest,n="/api/library-opening-times/current-week/_nocache?SQ_CALENDAR_VIEW=week&SQ_CALENDAR_DATE="+(e.week||"");a.open("GET",n,!0),a.onreadystatechange=function(){4===this.readyState&&(200<=this.status&&this.status<400?(t=JSON.parse(this.responseText),c({data:t,todayClean:t.todayClean,todayDay:t.todayDay,queryWeek:t.queryWeek,updateElements:e.updateElements})):{error:!0})},a.send(),a=null,e.updateElements.addClass("opening-times-busy")},m=function(e){var t=new Date(e,3,0);return t.setDate(t.getDate()-t.getDay()),t},u=function(e){var t=new Date(e,10,0);return t.setDate(t.getDate()-t.getDay()),t},c=function(n){var i,s,r,o,d,l,e=T("[data-times-type=daily]"),t=T("[data-times-type=weekly]"),a=T("[data-times-type=call-to-action]"),p="",m="",u=n.updateElements;0<e.length?u.each(function(){var e=T(this),t=e.attr("data-library-id"),a=n.data.libraries[t].times[n.todayDay];r=a.special,o=a.date,d=a.startTime,l=a.endTime,T(".opening-times--home-controls h2 a time").html(n.todayClean),s=e.find(".opening-times--home-list-item-times"),p="closed"===r?"<span><em>Closed</em></span>":"open24hours"===r?"<span><em>Open 24 hours</em></span>":'<time datetime="'+o+"T"+d.replace(".",":")+'">'+d+'</time><span> &ndash; </span><time datetime="'+o+"T"+l.replace(".",":")+'">'+l+"</time>",s.html(p),e.removeClass("opening-times-busy")}):0<t.length?function(C,e){e.each(function(){for(var e,t,a,n,i,s,r,o,d,l,p,m,u,c,g=T(this),h=g.attr("data-library-id"),y=C.data.libraries[h],f=(y.times,g.find(".opening-times-list-card .opening-times-panel--left .opening-times-table tbody")),D="",v="",b=0;b<k.length;b++)y.times[k[b]]?(t=(e=y.times[k[b]]).special,a=e.date,n=e.dateClean.split(",",1),i=e.startTime,s=e.endTime,D+=e.isToday?'<tr data-date="'+n+'" class="is-today">':'<tr data-date="'+n+'">',D+="<td><span>"+_(k[b])+"</span></td>",D+="<td>",D+="closed"===t?"<span><em>Closed</em></span>":"open24hours"===t?"<span><em>Open 24 hours</em></span>":'<time datetime="'+a+"T"+i.replace(".",":")+'">'+i+'</time><span> &ndash; </span><time datetime="'+a+"T"+s.replace(".",":")+'">'+s+"</time>",D+="</td>"):(D+="<tr>",D+="<td><span>"+_(k[b])+"</span></td>",D+="<td><span>No time available</span></td>"),D+="</tr>";v=""!==C.queryWeek?(r=C.queryWeek.split("-"),o=new Date(r[0],r[1]-1,r[2]),d=w(o,6),l=o.getDate()+" "+A(o)+" until "+d.getDate()+" "+A(d),p=w(o,7),m=E(p),u=w(o,-7),c=E(u),g.find(".opening-times-navigation-previous a").attr("href","?SQ_CALENDAR_VIEW=week&SQ_CALENDAR_DATE="+c),g.find(".opening-times-navigation-next a").attr("href","?SQ_CALENDAR_VIEW=week&SQ_CALENDAR_DATE="+m),l):C.data.currentWeekRange,g.find(".opening-times-navigation-date-range time").text(v).attr("data-toggle","on"),f.html(D),g.removeClass("opening-times-busy")})}(n,u):0<a.length&&u.each(function(){var e,t=T(this),a=t.find(".library-aside-call-to-action-subtitle");i=t.attr("data-library-id"),e=n.data.libraries[i].times[n.todayDay],r=e.special,o=e.date,d=e.startTime,l=e.endTime,s=t.find(".library-aside-call-to-action-title"),"closed"===r?p="Closed":(p="Open",m="open24hours"===r?"24 hours":'until <time datetime="'+o+"T"+l.replace(".",":")+'">'+l+"</time>"),p+=" Today",s.html(p),a.html(m),t.removeClass("opening-times-busy")})};return{init:function(){n.remove(),i.on("click",d),T(".library-search__content-type").change(o),0!==t&&(p({week:"",updateElements:T("[data-times-type]")}),a.on("click",function(e){var t=T(this),a=t.attr("href").split("=")[2],n=t.parents("[data-times-type]");n.hasClass("opening-times-busy")||p({week:a,updateElements:n}),e.preventDefault()}))}}}($);